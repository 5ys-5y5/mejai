## 전체 그림 (초직관 요약)

- **`playground_route.ts` = “상담 매니저(오케스트레이터)”**
    - 고객이 뭐라고 했는지 보고
    - **정보가 부족하면** “주문번호 주세요 / 주소 주세요” 같은 **확인 질문**을 만들고
    - 정보가 충분하면 **도구(MCP)로 조회/처리**하고
    - 마지막에 **LLM에게 답변 글쓰기**를 시킵니다.
- **`llm.ts` = “작가(LLM) 호출 버튼”**
    - “ChatGPT 쓸지 / Gemini 쓸지” 결정하고
    - “큰 모델 쓸지 / 작은 모델 쓸지” 간단 규칙으로 골라서
    - 답변 텍스트를 받아옵니다.

---

## 1) `llm.ts` — “작가 고용하기” 버튼

### 얘가 하는 일은 딱 2개

1. **어느 회사 작가를 부를지**: `chatgpt` vs `gemini`
2. **고급 작가/보급 작가를 부를지**: 길거나 “자세/복잡/정확” 같은 단어가 있으면 고급

### 머릿속 그림

- 입력: (systemPrompt, userPrompt, llm종류)
- 처리:
    - `prompt가 길거나 자세히 요구하면` → 비싼 모델
    - 아니면 → 싼 모델
- 출력: `{ text, model }`

### 직관적인 리스크(중요)

- 유저가 습관적으로 “자세히”만 써도 **항상 비싼 모델**로 올라갈 수 있음(비용 폭탄 가능).
- 네트워크 오류/429(요청 많음) 같은 상황에 대한 **재시도/타임아웃/길이 제한**이 거의 없음.

---

## 2) `playground_route.ts` — “상담 매니저”의 3단계

이 파일의 행동은 사실상 **3단계 상태 머신**입니다.

### 단계 A) “재료(정보) 모으기”

- agent/kb/admin kb 불러오기
- 세션 만들기(없으면 생성)
- 최근 대화(turns) 불러오기
- 유저 메시지에서 **주문번호/주소/전화/의도(intent)** 대충 추출

> 직관: “지금 이 손님이 뭘 원하는지”와 “처리하려면 뭘 더 물어봐야 하는지” 판단하는 단계
> 

---

### 단계 B) “확인 질문 만들기(대부분 여기로 감)”

이 코드의 가장 큰 특징:

- **바로 답을 잘 안 하고**, 거의 항상 **확인 질문(confirm)** 을 먼저 던집니다.

### 어떤 상황에서 확인 질문이 뜨냐? (초간단 규칙)

1. 배송/환불/변경 같은 “업무”인데 **주문번호/전화가 없음**
    - → “주문번호 또는 휴대폰 번호 알려주세요”
2. “배송지 변경” 느낌인데 **주소가 없음**
    - → “새 주소 알려주세요”
3. **전화번호만 있음**(주문번호 없음)
    - → 도구로 “최근 주문 3개” 뽑아 보여주고
    - → “어느 주문인가요? 주문번호 선택해주세요”
4. 주문번호+주소+변경 의도면
    - → “이 주소로 변경 맞나요?” confirm
5. 그 외 대부분
    - → LLM에게 “요약 + 확인 질문” 만들어오라고 시킴

> 직관: “실수로 처리하면 사고나니까, 거의 모든 케이스에서 ‘제가 이해한 게 맞나요?’ 한 번 더 확인”
> 

---

### 단계 C) “확인이 끝났으면 실제 처리 + 최종 답변”

유저가 “네/예/맞아요” 같은 확인을 하면(또는 주문번호만 던지면 확인으로 간주):

1. **MCP 도구 호출(실제 행동/조회)**
    - 주문 조회(lookup_order)
    - 배송 조회(track_shipment) — 질문에 배송 단어 있으면
    - 티켓 생성(create_ticket) — 변경/환불/일반 문의
2. 그 결과를 정리해서
3. **LLM에게 최종 답변을 쓰게 함**
    - “KB 내용 기반으로만 답해라” 같은 시스템 프롬프트 +
    - 고객 질문 + KB + MCP 결과를 한 번에 넣고 글을 씀

> 직관: “도구로 사실을 가져오고 → 작가(LLM)가 그걸 예쁘게 말로 정리”
> 

---

## 3) 이 코드의 핵심 포인트를 “한 문장”으로

- **`playground_route.ts`는 ‘확인 질문으로 사고를 막는 상담 흐름’을 만드는 엔진이고,**
- **`llm.ts`는 그 흐름에서 필요한 문장 생성(확인 질문/최종 답변)을 LLM에게 시키는 호출기입니다.**

---

## 4) 정말 직관적으로 위험한 부분 3개만 꼽으면

1. **“네/예” 판정이 너무 단순**
    - “예전 주문…” 같은 문장도 “예”로 시작하면 yes로 오판 가능
2. **주소 추출이 너무 허술**
    - “101호” 같은 조각만 잡혀도 “주소”로 처리될 수 있음 → 잘못된 변경 티켓 위험
3. **에러 처리(try/catch)가 부족**
    - LLM/MCP 호출 실패 시 500으로 터질 수 있음(사용자 경험, 운영 안정성 문제)