# Supabase Quota 초과 긴급 대응 가이드 (2026-02-03)

## 0) 현재 상황 요약
- 증상: `Organization plan has exceeded its quota`
- 관찰 패턴: 동일 IP(14.36.150.116), 동일 리퍼러(`https://mejai.help`)에서 짧은 시간 동안 동일 GET 반복 호출
- 반복 엔드포인트(확인됨)
  - `/auth/v1/user`
  - `/rest/v1/A_iam_user_access_maps`
  - `/rest/v1/E_ops_review_queue_items` (limit 변형 포함)
- DB/Storage/Edge/Realtime 로그에서 치명 오류는 없고, API/PostgREST 호출량이 과도한 상태

## 1) 오늘 즉시 할 일 (우선순위)

### P0. 트래픽 급감 조치 (당일)
1. 폴링 중지 또는 주기 상향
   - 1~5초 폴링 -> 최소 30~60초로 상향
   - 가능하면 사용자 액션 기반(탭 포커스/버튼 클릭)으로만 갱신
2. 중복 요청 차단
   - 동일 key 요청은 1회만 보내고, 진행 중(in-flight) 요청 재사용
   - 화면 재렌더링으로 동일 fetch가 재실행되지 않도록 의존성 배열/호출 위치 점검
3. Auth 호출 억제
   - `/auth/v1/user` 반복 호출 제거
   - 세션 정보는 전역 상태/캐시에서 재사용 (페이지마다 재호출 금지)

### P1. 데이터 요청 최적화 (당일~익일)
1. 쿼리 경량화
   - `select *` 금지, 필요한 컬럼만 명시
   - 불필요한 `order` 제거
   - `limit` 최소화 (예: 50 -> 20)
2. 요청 통합
   - 동일 화면에서 같은 리소스를 여러 컴포넌트가 따로 조회하지 않게 상위에서 1회 조회 후 전달
3. 캐시 도입
   - React Query/SWR 기준 `staleTime`, `refetchOnWindowFocus`, `refetchInterval` 정책 명시

### P2. 구조 개선 (이번 주)
1. 폴링 -> Realtime 전환 검토
   - 변경 이벤트 수신 기반으로 전환해 무변경 구간 트래픽 제거
2. 서버 캐시 정책
   - 변경 빈도 낮은 목록/메타데이터 응답에 `Cache-Control` 적용
3. 관측성 추가
   - 엔드포인트별 호출수/사용자/화면 단위 계측(최소 1분 집계)

## 2) 프론트엔드 구현 체크리스트
- [ ] `useEffect` 의존성 배열로 인한 무한/중복 fetch 점검
- [ ] React StrictMode(개발환경) 중복 호출과 운영 호출 분리 확인
- [ ] 페이지 진입/탭 전환/포커스 시 재요청 트리거 확인
- [ ] 같은 query key가 컴포넌트마다 다르게 생성되지 않는지 확인
- [ ] 재시도(retry) 정책 과도 설정 여부 확인 (예: 3회 이상 자동 재시도)

## 3) 권장 기본값 (임시 안전 설정)
- 목록성 데이터
  - `staleTime`: 30~120초
  - `refetchOnWindowFocus`: false (운영)
  - `refetchInterval`: 기본 off, 필요 시 60초+
- 사용자 세션/권한 맵
  - 라우트 이동마다 재조회 금지
  - 로그인/권한 변경 이벤트 시에만 재검증
- 긴급 상황 플래그
  - `POLLING_DISABLED=true` 같은 환경변수로 즉시 폴링 차단 가능하게 구성

## 4) Supabase 대시보드에서 바로 볼 항목
1. Usage
   - API requests
   - Egress / Bandwidth
   - DB compute / connections
2. Logs
   - API, PostgREST에서 상위 다빈도 경로 확인
3. Auth
   - `getUser()` 호출량 증가 여부

## 5) 재발 방지 운영 룰
- 기능 추가 시 "요청 예산"을 PR에 명시 (화면 진입당 요청 수, 백그라운드 분당 요청 수)
- 신규 폴링은 기본 금지, 예외만 승인
- 동일 리소스는 단일 데이터 레이어에서 소유
- 주 1회 상위 10개 고빈도 엔드포인트 점검

## 6) 이번 이슈의 원인 가설 (현재 가장 유력)
- 프론트엔드에서 동일 리소스에 대한 짧은 주기 폴링 + 중복 렌더링/중복 fetch가 결합됨
- 그 결과 API 호출 수/대역폭/DB 커넥션 사용량이 빠르게 누적되어 조직 쿼터 초과 발생

## 7) 완료 기준 (Done)
- 24시간 기준 API 호출량 50% 이상 감소
- 상위 3개 엔드포인트 호출수 급감 확인
- 사용자 체감 기능 저하 없이 대시보드 큐터 경고 해소
