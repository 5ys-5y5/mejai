# MCP 로컬 검증

### DB/정책 확인(직접 실행 필요)

1) auth_settings 존재 및 RLS 정책 확인
```sql
select schemaname, tablename, policyname
from pg_policies
where tablename = 'auth_settings'
order by policyname;
```

2) auth_oauth_tokens 제거 여부 확인
```sql
select table_name
from information_schema.tables
where table_schema = 'public'
  and table_name = 'auth_oauth_tokens';
```

3) providers.cafe24 키 확인
```spl
select
  providers->'cafe24' as cafe24
from auth_settings
where org_id = '8ad81b6b-3210-40dd-8e00-9a43a4395923'
  and user_id = 'fa7baaa2-806f-4457-88f0-7d29f802d126';
```

### 데이터 기준 확인 (member_id/order_id)

4) member_id=mejai 고객 조회
```powershell
$token = "Rj01VQOiDpKiXXB5IOjq9A";
Invoke-RestMethod -Method Get `
  -Uri "https://sungjy2020.cafe24api.com/api/v2/admin/customers?shop_no=1&member_id=mejai" `
  -Headers @{ Authorization = "Bearer $token" }
```

5) order_id=20260127-0000014 주문 조회
```powershell
Invoke-RestMethod -Method Get `
  -Uri "https://sungjy2020.cafe24api.com/api/v2/admin/orders/20260127-0000014?shop_no=1" `
  -Headers @{ Authorization = "Bearer $token" }
```

### 로컬 서버 확인
```js
const key = Object.keys(localStorage).find(k => k.includes("auth-token"));
const raw = localStorage.getItem(key || "");
const token = raw ? (JSON.parse(raw).access_token || JSON.parse(atob(raw)).access_token) : "";

fetch("/api/mcp/tools/call", {
  method: "POST",
  headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
  body: JSON.stringify({ tool: "find_customer_by_phone", params: { member_id: "mejai" } })
}).then(r => r.json()).then(console.log);

fetch("/api/mcp/tools/call", {
  method: "POST",
  headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
  body: JSON.stringify({ tool: "lookup_order", params: { order_id: "20260127-0000014", customer_verification_token: "TEST" } })
}).then(r => r.json()).then(console.log);
```


# MCP 배포 검증  (https://www.mejai.help/ (로그인 필수))

1) 토큰 추출 + `find_customer_by_phone` 검증
```js
const key = Object.keys(localStorage).find(k => k.includes("auth-token"));
const raw = localStorage.getItem(key || "");
const token = raw ? (JSON.parse(raw).access_token || JSON.parse(atob(raw)).access_token) : "";

fetch("/api/mcp/tools/call", {
  method: "POST",
  headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
  body: JSON.stringify({ tool: "find_customer_by_phone", params: { member_id: "mejai", debug: true } })
}).then(r => r.json())
  .then(res => console.log(JSON.stringify(res)));
```

2) `lookup_order` 요약/마스킹 검증
```js
fetch("/api/mcp/tools/call", {
  method: "POST",
  headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
  body: JSON.stringify({ tool: "lookup_order", params: { order_id: "20260127-0000014", customer_verification_token: "TEST" } })
}).then(r => r.json())
  .then(res => console.log(JSON.stringify(res)));
```

3) `_debug`만 확인 (정상 쿼리 확인용)
```js
fetch("/api/mcp/tools/call", {
  method: "POST",
  headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
  body: JSON.stringify({ tool: "find_customer_by_phone", params: { member_id: "mejai", debug: true } })
}).then(r => r.json())
  .then(res => console.log(res.data?._debug || res));
```