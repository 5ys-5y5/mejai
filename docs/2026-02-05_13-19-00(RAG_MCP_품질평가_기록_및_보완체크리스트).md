# RAG/MCP 구현 품질 평가 기록 및 보완 체크리스트

- 기록 시각: 2026-02-05 13:19:00
- 작성 위치: docs/reply/2026-02-05_13-19-00(RAG_MCP_품질평가_기록_및_보완체크리스트).md

## 사용자 질문 원문

아래 관점으로 본 서비스의 구현된 코드의 품질을 평가해주세요.
(코드의 수정은 금지합니다. 본 대화의 요청은 평가입니다)

5) KnowledgeBase(RAG)  정답 근거를 만드는 필수 개념
   - 필수 개념
      - RAG 기본: 문서 분할/인덱싱/임베딩/리랭킹/출처 표시
      - 고객센터는 특히:
         - 정책/약관처럼 정확히 인용해야 하는 문서
         - 개인화 데이터(주문/예약/계정)처럼 권한 통제 필수인 데이터
      - 대화형 검색: 질문이 애매하면 먼저 확인 질문  그 다음 조회
   - 추천 학습 포인트(논문보다 개념이 더 중요)
      - Retrieval 평가(정답률) + LLM 답변 평가(근거 충실도) 분리
      - 최신성/버전관리(정책 문서 바뀌면 즉시 반영), 캐시 무효화
      - PII 마스킹/레드액션(로그 포함)

6) MCP(tooling) + runtime 오케스트레이션  질문에 적어주신 구조의 핵심
   질문에서 말한 runtime[MCP(scope, action(endpoint)), KnowledgeBase, LLM]은 본질적으로 도구 레지스트리 + 권한 스코프 + 실행기 + 관측가능성 문제입니다.
   - 필수 개념
      - Tool discovery(list) / invoke(call) / schema validation
      - 스코프 기반 권한(예: billing.read, reservation.modify)과 정책 엔진
      - 툴 결과의 신뢰 경계: 툴 출력은 사실, LLM은 해석/요약
      - 실패 설계: 툴 타임아웃/부분 실패/재시도/보상 트랜잭션
      - 감사 로그(audit log): 누가(어떤 세션) 어떤 권한으로 어떤 endpoint를 호출했는지
   - 읽을거리(대표)
      - MCP를 계측/분석한 연구(도구 목록/호출 흐름 등):
      - MCP 서베이/개념 정리(도구/리소스/프롬프트, tools/listtools/call 등):





## 이전 답변 요약(코드 평가 결과)

### 주요 발견(심각도 순)

1. Critical — MCP 신뢰 경계 우회
   - `src/app/api/debug/mcp/route.ts:21`가 `callAdapter` 직접 호출로 레지스트리/스코프/스키마/레이트리밋/감사정책 경로 우회 가능.

2. High — RAG 핵심 미구현
   - 런타임이 KB 전체를 프롬프트에 직접 주입(`src/app/api/runtime/chat/runtime/finalizeRuntime.ts:17`).
   - 문서 분할/벡터 검색/리랭킹/근거 스니펫 인용 파이프라인 부재.

3. High — PII 로그 노출
   - 전화/주소 원문이 이벤트·디버그·감사 payload에 저장됨.

4. High — 최신성/버전 반영 취약
   - KB 버전 증가 로직은 있으나 에이전트 참조 전환이 부분적이며, 런타임 조회에서 활성 버전 강제 부족.

5. Medium — 권한/테넌트 경계의 RLS 의존도 높음
   - `orgId`를 코드에서 강제하지 않는 조회 다수.

6. Medium — Tool schema validation 약함
   - required/기본 타입 위주 검증, enum/range/pattern/nested 검증 부재.

7. Medium — 실패 설계 미흡
   - 외부 호출 timeout/abort 부재, 직렬 실행, 보상 트랜잭션 미흡.

8. Medium — Retrieval/LLM 평가 분리 부재
   - `/app/eval`가 정적 수준, 운영 지표화 부족.

### 긍정 요소

- 애매 질의 확인 질문(의도 디스앰비규에이션) 흐름 존재.
- MCP list/call/audit 뼈대 존재.
- 민감 액션 전 OTP 게이트 존재.

## 보완 실행 체크리스트

### P0 (즉시)

- [ ] `debug/mcp` 엔드포인트 운영 차단(또는 관리자+개발모드+내부망 제한) 및 직접 adapter 호출 금지.
- [ ] 감사/이벤트/디버그 로그에서 PII 원문 저장 금지(전화/주소/인증코드/토큰 전면 마스킹).
- [ ] 세션/턴/이벤트 조회 API에 `org_id` 스코프 검증을 코드 레벨에서도 강제.
- [ ] MCP 호출 경로를 단일화(`/mcp/tools/call`)하여 레이트리밋·정책·마스킹·감사 공통 적용.

### P1 (단기)

- [ ] RAG 파이프라인 구현: chunking → embedding → vector search(top-k) → rerank → evidence 추출.
- [ ] 답변에 근거 스니펫+문서ID+버전+오프셋을 구조화하여 저장/반환.
- [ ] KB 최신 활성 버전만 조회하도록 런타임 조회 조건 정비(`is_active`, `parent_id` 기준 최신 선택).
- [ ] KB 변경 시 캐시 무효화/리인덱싱 트리거 자동화.
- [ ] Tool schema 검증을 JSON Schema 수준(중첩/enum/pattern/min-max)으로 강화.

### P2 (중기)

- [ ] MCP 실행기 표준화: timeout, retry(backoff), partial failure 핸들링, idempotency key.
- [ ] 보상 트랜잭션 설계(예: 구독 저장 성공 + 후속 예약 실패 시 복구 작업).
- [ ] Tool 결과(사실) vs LLM 해석(요약) 구분 필드를 감사로그에 명시.
- [ ] 정책 엔진에 scope 매핑 규칙과 deny-by-default 적용.

### 검증/운영

- [ ] Retrieval 평가셋 구축(질문-정답근거 문서쌍) 및 Recall@k, MRR, nDCG 측정.
- [ ] LLM 답변 평가 분리(근거 충실도/사실성/불확실성 고지) 자동 채점 파이프라인 구축.
- [ ] 보안 회귀 테스트 추가(PII 로그 누출, 권한 우회, 테넌트 교차 조회).
- [ ] 장애 주입 테스트(timeout/429/5xx)로 재시도·복구 동작 검증.
- [ ] 감사로그 대시보드에 "누가/어떤 세션/어떤 scope/어떤 endpoint" 필수 항목 표시.

## 제안 실행 순서

1. P0 보안 차단 및 로그 마스킹
2. RAG 근거 체인(검색-리랭크-인용) 구축
3. MCP 런타임 실패 설계/보상 트랜잭션
4. 평가 자동화( Retrieval vs LLM 분리 )
