# 단계별 구현 체크리스트 및 검증 (Exit Criteria)

이 문서는 Mejai Help MVP 개발의 진행 상황을 추적하고, 각 단계의 완료 기준을 명확히 하기 위해 사용됩니다.

---

## 의사결정 로그 (진행 중)

- [x] WebSocket 서버 구성 선택 (Owner: USER)
  - 선택지: (1) 별도 WS 서버(`ws` 패키지) 추가, (2) 외부 WS 서버(`NEXT_PUBLIC_CALL_WS_URL`) 재사용
  - 선택: (1) 별도 WS 서버(`ws` 패키지) 추가
- [x] 주문 조치 범위 확정 (Owner: USER)
  - 범위: 현재 MCP로 실행 가능한 범위(`lookup_order`, `track_shipment`, `create_ticket`)
  - 추가 실행 액션(주문 상태 변경/환불/취소 등)은 보류
- [x] LLM SDK/WS 패키지 설치 승인 (Owner: USER)
  - 필요 패키지: `openai`, `@google/generative-ai`, `ws`
- [x] KB 임베딩 생성 파이프라인 필요 여부 확정 (Owner: USER)
  - `knowledge_base.embedding` 미존재 시 생성/재인덱싱 흐름 필요
  - 선택: 작성/수정 시 즉시 생성(동기식)

---

## Phase 1: Project Setup & Foundation (완료)

- [x] Next.js 프로젝트 생성 (TypeScript, Tailwind CSS, App Router)
- [x] 초기 보일러플레이트 코드 정리
- [x] 필수 의존성 설치 (`lucide-react`, `framer-motion`, `clsx`, `tailwind-merge`, `class-variance-authority`, `@radix-ui/react-slot`, `sonner`, `@supabase/supabase-js`)
- [x] 프로젝트 디렉토리 구조 생성 (`/src/components`, `/src/lib`, `/src/hooks`, app routes)
- [x] 핵심 유틸리티 함수 생성 (`cn` for classnames)
- [x] `mejai_UI.jsx`를 기반으로 재사용 가능한 UI 컴포넌트 분리
  - [x] `/src/components/ui` 경로에 `Card`, `Badge`, `Input`, `Divider`, `Skeleton`, `Button` 등 생성
- [x] Mock 인증 로직 생성 (`/src/lib/auth.ts`)
- [x] 애플리케이션 셸(Shell) 컴포넌트 생성
  - [x] `AppShell`
  - [x] `AppHeader`
  - [x] `AppSidebar`
  - [x] `ProfileMenu`
  - [x] `MobileDrawer`
  - [x] `HelpPanel` 및 관련 `useHelpPanel` 훅
- [x] 인증 관련 페이지 생성
  - [x] 로그인 (`/login`)
  - [x] 회원가입 (`/signup`)
  - [x] 계정 검증 (`/verify`)
  - [x] 비밀번호 재설정 (`/forgot`)
  - [x] 온보딩 (`/onboarding`)
- [x] 인증된 사용자를 위한 메인 앱 레이아웃 생성 (`/app/layout.tsx`) 및 `RequireAuth` 컴포넌트를 통한 라우트 보호

---

## Phase 2: Operator Console UI Implementation (진행 중)

- [x] **대시보드 페이지 (`/app/page.tsx`)**
  - [x] `Metric` 컴포넌트 생성
  - [x] `AgentSelectPopover` 컴포넌트 생성
  - [x] `DateRangePopover` 컴포넌트 생성
  - [x] `DashboardPage` 컴포넌트 조립 및 Mock 데이터 연동
  - [x] 더미 데이터 제거 및 Supabase 세션/리뷰 기반 조회 적용
  - [x] "이관률" 카드 추가 (요청사항 반영)
- [x] **통화/세션 목록 페이지 (`/app/calls/page.tsx`)**
- [x] **통화/세션 상세 페이지 (`/app/calls/[sessionId]/page.tsx`)**
  - [x] F-B1 필수 요소 반영 (ASR/요약/확인/응답/만족도/이관 사유/오디오 구간)
- [x] **통화 중 웹 입력 페이지 (`/call/[token]/page.tsx`)**
- [x] **기타 운영자 콘솔 페이지 (mejai_UI.jsx 반영)**
  - [x] 후속 지원 요청 (`/app/review`)
  - [x] 에이전트 (`/app/agents`)
  - [x] 평가/관리 (`/app/eval`)
  - [x] 지식 베이스 (`/app/kb`)
  - [x] 규칙 (`/app/rules`)
  - [x] 설정 (`/app/settings`)
  - [x] 결제/플랜 (`/app/billing`)
  - [x] 팀/권한 (`/app/team`)
  - [x] 감사 로그 (`/app/audit`)
- [x] **랜딩 페이지 (`/`)**
  - [x] Spline 3D 컴포넌트 연동 (`@splinetool/react-spline`)
  - [x] `mejai_UI.jsx` 기반 섹션 구성
  - [x] Spline 런타임 이슈 우회 (iframe 임베드)

---

## Phase 3: Backend & Database Integration (진행 중)

- [ ] 최우선 검증: 실제 통화 → LLM → KB → TTS 응답 루프 검증
  - [ ] 통화 수신 Webhook/Provider 연동(Twilio/Telnyx 등) 확보
  - [ ] 통화 세션 생성 시 agent/KB 바인딩 확인
  - [ ] 질문 → LLM 프롬프트 구성(조직/규칙/KB 컨텍스트 포함)
  - [ ] KB 검색(RAG) 결과가 LLM 응답에 반영되는지 확인
  - [ ] LLM 응답을 TTS로 변환하여 통화 음성으로 송출
  - [ ] 통화 종료 후 세션/턴/이벤트가 DB에 기록되는지 확인

- [x] Supabase 프로젝트 설정
- [x] PRD 기반 데이터베이스 스키마 설계 및 테이블 생성
- [x] Supabase Auth를 사용한 실제 사용자 인증 구현
  - [x] 이메일 인증 가입 플로우 적용
  - [x] 인증 완료 후 /login 리디렉션
  - [x] 가입 시 스팸함 확인 안내 문구 노출
- [x] 온보딩에서 조직(organizations) 생성 및 org_id 기반 데이터 연동
- [x] API 계약서 초안 작성 및 확장 (`docs/api_contract.md`)
- [x] RLS 정책 설계 및 적용
- [ ] 백엔드 Orchestrator API 엔드포인트 생성 (Node.js/TypeScript)
  - [x] 읽기 전용 API 라우트 추가 (sessions/turns/audio_segments/event_logs/review_queue/audit_logs/knowledge_base)
    - [x] GET /api/sessions
    - [x] GET /api/sessions/{id}
    - [x] GET /api/sessions/{id}/turns
    - [x] GET /api/sessions/{id}/audio-segments
    - [x] GET /api/sessions/{id}/events
    - [x] GET /api/review-queue
    - [x] GET /api/audit-logs
    - [x] GET /api/kb
  - [x] 쓰기 API 라우트 추가 (sessions/turns/audio_segments/event_logs/review_queue/knowledge_base)
    - [x] POST /api/sessions
    - [x] POST /api/sessions/{id}/turns
    - [x] POST /api/sessions/{id}/audio-segments
    - [x] POST /api/sessions/{id}/events
    - [x] POST /api/review-queue
    - [x] POST /api/kb
  - [x] 통화 시뮬레이션 API 추가 (`/api/simulate-call`)
  - [x] 단계별 처리 API 추가 (`/api/sessions/{id}/process`)
  - [ ] 통화 처리 시뮬레이션 로직
  - [ ] 대시보드 데이터 조회
  - [ ] 통화 로그 조회/관리
  - [ ] 지식 베이스(KB) 문서 관리
  - [ ] 규칙(Rules) 관리
  - [x] MCP 연동 구현
    - [x] MCP 도구 목록 API (`/api/mcp/tools`)
    - [x] MCP 도구 호출 API (`/api/mcp/tools/call`)
    - [x] MCP 정책(org 스코프) 반영
    - [x] MCP 관리자 권한 체크 (`user_access.is_admin`)
    - [x] 에이전트 생성에서 MCP 선택 UI (`/app/agents/new`)
    - [x] 규칙 페이지에 MCP 도구 목록 UI (`/app/rules`)
  - [ ] MCP 백엔드 검증 체크리스트 (서비스 기준)
    - [x] `src/lib/mcpAdapters.ts`에서 Cafe24 설정을 `auth_settings.providers.cafe24`에서 읽도록 구현되어 있다.
    - [x] `src/app/api/cafe24/authorize/route.ts`가 DB(auth_settings)에서 `mall_id`, `client_id`, `scope`를 읽는다.
    - [x] `src/app/api/cafe24/callback/route.ts`가 DB(auth_settings)에 토큰을 저장한다.
    - [x] `src/app/api/mcp/tools/call/route.ts`가 `callAdapter`에 `supabase/orgId/userId` 컨텍스트를 전달한다.
    - [x] `src/app/api/mcp/tools/route.ts`에 `MCP_TOKEN` 환경변수 fallback이 제거되어 있다.
    - [x] `auth_settings` 테이블 존재
    - [x] `auth_oauth_tokens` 테이블 제거됨(사용하지 않음)
    - [x] `auth_settings`의 RLS 정책(`auth_settings_read/write/update`) 존재
    - [x] `providers.cafe24`에 다음 키가 존재
      - [x] `mall_id`
      - [x] `client_id`
      - [x] `client_secret`
      - [x] `scope`
      - [x] `access_token`
      - [x] `refresh_token`
      - [x] `expires_at`
      - [x] `shop_no` (선택)
      - [x] `board_no` (선택)
    - [x] `org_id` / `user_id`가 현재 로그인 유저와 일치
    - [ ] 사용자가 로그인한 상태에서 `https://mejai.help/api/cafe24/authorize` 접근 시 302로 Cafe24 승인 URL로 이동
    - [ ] 승인 후 콜백(`https://mejai.help/api/cafe24/callback`)에서 DB에 토큰 저장
    - [ ] 콜백 응답이 `status: stored` 화면을 반환
    - [ ] 브라우저 로그인 세션 쿠키만으로 `/api/mcp/tools/call` 접근 가능
    - [ ] `MCP_TOKEN` 환경변수가 없어도 서비스에서 정상 인증됨
    - [ ] `list_boards`, `list_board_articles`, `list_orders`, `find_customer_by_phone`가 `mcp_tools`에 존재
    - [ ] 해당 도구들이 `mcp_tool_policies`에 org_id 기준으로 허용됨
    - [ ] `list_boards` 정상 응답
    - [ ] `list_board_articles` 정상 응답
    - [ ] `list_orders` 정상 응답
    - [ ] `find_customer_by_phone` 정상 응답
    - [ ] `lookup_order`, `track_shipment`, `create_ticket` 정상 응답
    - [ ] `expires_at`가 과거여도 요청 시 refresh_token으로 갱신
    - [ ] 갱신 후 `auth_settings.providers.cafe24.access_token`과 `expires_at`이 업데이트됨
    - [ ] 갱신 실패 시 명확한 에러 코드(`TOKEN_REFRESH_FAILED`) 반환
    - [ ] 주기 갱신 API(`/api/cafe24/refresh`)가 CRON_SECRET으로 보호됨
    - [ ] 주기 갱신 API가 만료 임박 토큰만 갱신함
    - [ ] Railway Cron Job에서 30분 주기로 `/api/cafe24/refresh` 호출됨
  - [ ] MCP 기능 범위 (Minimum / Recommended / Maximum)
    - [x] 최소 기능 (Minimum: MVP 운영 가능 기준)
      - [x] MCP 도구 목록 API (`/api/mcp/tools`)
      - [x] MCP 도구 호출 API (`/api/mcp/tools/call`)
      - [x] MCP 정책(org 스코프) 반영
      - [x] MCP 관리자 권한 체크 (`user_access.is_admin`)
      - [x] 에이전트 생성에서 MCP 선택 UI (`/app/agents/new`)
      - [x] 규칙 페이지에 MCP 도구 목록 UI (`/app/rules`)
    - [ ] 권장 기능 (Recommended: 운영 안정화 기준)
      - [ ] MCP 정책 관리 UI (허용/차단/스코프/속도제한)
      - [ ] MCP 도구 스키마 검증 강화(필수/타입/버전)
      - [ ] MCP 호출 결과 감사 로그/리포트 UI
      - [ ] MCP 실패/재시도 정책 및 알림
      - [ ] 마스킹 규칙 테스트 및 운영 검증 시나리오
      - [ ] 호출 성능/속도 제한 모니터링 지표
    - [ ] 최대 기능 (Maximum: 멀티테넌시 확장/대규모 운영)
      - [ ] 멀티 MCP 서버/연결 프로필 관리
      - [ ] 정책 엔진 연동(컨텍스트 기반 허용/차단)
      - [ ] 쿼터/비용 관리(테넌트별 사용량/한도)
      - [ ] 리플레이/시뮬레이터(실통화 없이 tool-call 검증)
- [ ] 프론트엔드 UI와 백엔드 API 연동
  - [x] 대시보드/세션 목록/세션 상세 읽기 연동
    - [x] /app 대시보드: GET /api/sessions, GET /api/review-queue
    - [x] /app/calls: GET /api/sessions
    - [x] /app/calls/{id}: GET /api/sessions/{id}, GET /api/sessions/{id}/turns, GET /api/sessions/{id}/audio-segments
  - [x] 리뷰 큐/지식 베이스 목록 읽기 연동
    - [x] /app/review: GET /api/review-queue
    - [x] /app/kb: GET /api/kb
  - [x] /app 대시보드에서 시뮬레이션 생성 트리거 UI 추가
  - [x] 사이드바 후속 지원 요청 뱃지 실데이터 연동
  - [x] 시뮬레이션 버튼 admin 조건 노출 적용
  - [x] 사용자 프로필 API 연동 (/api/user-profile)
  - [ ] 사용자 권한/플랜 스키마 적용 (user_access 테이블, Supabase SQL 실행 필요)
  - [x] 세션 상세에서 통화 처리 단계 트리거 UI 추가 (ASR/요약/확인/응답/이관)
  - [x] 통화 처리 단계 자동 흐름 트리거 UI 추가 (자동 처리/자동 이관)
- [ ] Supabase Storage를 사용한 통화 녹음 파일 저장/관리 구현
- [ ] Supabase Auth 설정(도메인/템플릿/Redirect URL) 적용 (우선순위: 마지막)
  - [ ] Site URL/Redirect URL 설정 완료 확인
  - [ ] 커스텀 SMTP 연결 확인
  - [ ] 커스텀 템플릿 적용 확인

---

## Phase 3.5: Playground LLM/MCP/KB + Cafe24 주문 조치 테스트 (신규)

### 0) 사전 확정 (결정 필요)
- [x] WebSocket 서버 구성 선택 확정 (Owner: USER)
- [ ] 주문 조치 범위 확정 (Owner: USER)
- [ ] SDK/WS 패키지 설치 승인 (Owner: USER)
- [x] KB 임베딩 파이프라인 필요 여부 확정 (Owner: USER)

### 1) DB/스키마 상태 정리
- [x] `bot_context` jsonb 컬럼 추가 SQL 제공 (Owner: LLM)
- [x] `bot_context` 컬럼 적용 완료 (Owner: USER)
- [ ] `bot_context` 기록 키 스키마 확정 (Owner: LLM)
  - 예: `agent_version_id`, `kb_version_id`, `mcp_tool_versions`, `model`, `trace_id`

### 2) LLM SDK 연동 (Node.js)
- [x] OpenAI SDK 연동 (Owner: LLM)
  - [x] `OPENAI_API_KEY` 환경 변수 사용
  - [x] `gpt-4.1-mini`, `gpt-4.1` 라우팅 구현
- [x] Gemini SDK 연동 (Owner: LLM)
  - [x] `GEMINI_API_KEY` 환경 변수 사용
  - [x] `gemini-2.5-flash-lite`, `gemini-2.5-pro` 라우팅 구현
- [x] 공통 응답 포맷/에러 핸들링 정의 (Owner: LLM)

### 3) WebSocket 서버 구축
-- [x] WS 서버 방식 확정 (Owner: USER)
-- [x] WS 서버 구현 (Owner: LLM)
  - [x] `ws-server.js` 엔트리포인트 추가
  - [x] `npm run ws` 스크립트 추가
  - [ ] Railway Start Command를 `npm run ws`로 설정
  - [ ] WS Public URL을 `NEXT_PUBLIC_CALL_WS_URL`에 반영
  - [ ] Playground → WS 연결 → 메시지 송수신
  - [ ] LLM 스트리밍 토큰을 WS로 전달

### 4) KB RAG 연동
- [ ] 활성 KB 조회: `knowledge_base.is_active = true` (Owner: LLM)
- [ ] 임베딩/검색 로직 구현 또는 기존 파이프라인 연결 (Owner: LLM)
  - [x] 작성/수정 시 즉시 임베딩 생성(동기식) 구현
- [ ] RAG 결과를 프롬프트에 포함 (Owner: LLM)
- [ ] `turns.kb_references`에 근거 저장 (Owner: LLM)

### 5) MCP 연결 및 Cafe24 주문 조치
- [ ] MCP 정책 확인/스키마 검증 흐름 유지 (Owner: LLM)
- [ ] Cafe24 도구 호출 연결 (Owner: LLM)
  - [ ] `find_customer_by_phone` 또는 `lookup_order`로 order_id 확인
  - [ ] order_id 발견 시 승인된 조치 실행 (예: `create_ticket`/`track_shipment`)
- [ ] `mcp_tool_audit_logs.bot_context` 기록 (Owner: LLM)

### 6) Playground 통합 플로우
- [ ] Playground에서 agent 선택 → LLM/MCP/KB로 실제 응답 생성 (Owner: LLM)
- [ ] `sessions/turns/event_logs/review_queue/audio_segments`에 `bot_context` 기록 (Owner: LLM)
- [ ] `mejai_Guideline 1~8` 단계 형태로 기록 검증 (Owner: LLM)

### 7) 테스트 시나리오/검증
- [ ] 주문번호 포함 질문으로 주문 조회 성공 케이스 (Owner: USER+LLM)
- [ ] 주문번호 미발견 → 추가 질문/에스컬레이션 케이스 (Owner: USER+LLM)
- [ ] MCP 호출 실패 → 정책/마스킹/에러 로그 검증 (Owner: USER+LLM)
- [ ] KB 근거 부족 → 답변 보류/추가 질문 검증 (Owner: USER+LLM)

### 8) 완료 기준 (Exit Criteria)
- [ ] Playground에서 실제 LLM 응답 스트리밍 확인
- [ ] Cafe24 order_id 찾기 및 허용 조치 실행 확인
- [ ] 모든 단계가 `bot_context`로 추적 가능

---

## Phase 4: Testing & Finalization (대기)

- [ ] 단위/통합 테스트 작성 (테스트 커버리지 >70% 목표)
- [ ] 핵심 사용자 플로우에 대한 E2E 테스트 수행
- [ ] PRD의 MVP 완료 기준에 부합하는지 최종 검토



0127 복수의 mall_id에 따른 MCP등록 구현 완료 -> cafe24_mcp_test_cmd.txt 파일을 바탕으로 각종 기능 점검 필요
