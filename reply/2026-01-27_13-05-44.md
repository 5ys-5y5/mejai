# 이전 질문
1. Vercel이 아닙니다. (railway+supabase)
2. 만료 가능성이 있는 모든 토큰은 모든 대상에 대해 주기 갱신을 적용해야 합니다.

현재 환경은 railway 배포 supabase DB입니다.

# 이전 답변
좋습니다. Railway 배포 + Supabase DB 기준으로 설계 업데이트 드립니다.

설계 요약(railway 기준)
- Railway에서 **주기 실행 작업(Cron Job)** 을 별도로 구성해, 내부 API 엔드포인트를 90분마다 호출합니다.
- 해당 엔드포인트는 **모든 org/user의 Cafe24 토큰 중 만료 임박 토큰만 갱신**합니다.
- “요청 시 401이면 갱신” 로직은 그대로 두고, **주기 갱신을 추가**해서 토큰 만료를 예방합니다.

변경 예정(파일/지점)
- `src/lib/cafe24Tokens.ts` (신규)
  - `isExpiringSoon(expires_at)` / `refreshCafe24Token(...)` 공용화
- `src/lib/supabaseAdmin.ts` (신규)
  - `SUPABASE_SERVICE_ROLE_KEY`로 admin client 생성
- `src/app/api/cafe24/refresh/route.ts` (신규)
  - 전체 `auth_settings`에서 `providers.cafe24` 있는 row 조회
  - `expires_at`가 현재 + 45분 이내인 것만 refresh
  - 성공/실패 집계 리턴
  - `CRON_SECRET`으로 보호
- `src/lib/mcpAdapters.ts`
  - 기존 `refreshCafe24Token`를 공용 모듈로 이동
  - 기존 요청 시 refresh 로직은 유지
- `docs/단계별_구현_체크리스트_및_검증.md`
  - 주기 갱신 항목 추가

Railway 설정(운영)
- **Railway Cron Job** 설정:
  - Schedule: `*/90 * * * *` 같은 정확 90분은 지원이 제한적일 수 있어, 일반적으로 `*/30`으로 돌리고 **만료 임박 필터**로 제어합니다.
  - 실행 명령 예시: `curl -H "x-cron-secret: $CRON_SECRET" https://mejai.help/api/cafe24/refresh`
- 필요한 환경 변수:
  - `SUPABASE_SERVICE_ROLE_KEY`
  - `CRON_SECRET`

질문(진행 전에 확인 필요)
1) Railway에서 Cron Job을 **30분 주기**로 돌려도 괜찮나요?  
   (정확 90분이 필요하면, cron 스케줄러 지원 여부 확인 후 맞춤으로 조정)
2) refresh 엔드포인트의 접근 URL은 현재 운영 도메인 `https://mejai.help`가 맞나요?

확인되면 바로 코드 변경 들어가겠습니다.

# 질문
1. 네
2. 우선 로컬에서 확인할 수 없나요?

추가로 기록할 저의 질문과 당신의 답변은 앞선 cron 설계에 대한 것도 포함입니다

# 답변
네, 로컬에서도 확인 가능합니다. 다만 실제 Supabase DB와 통신하므로 `SUPABASE_SERVICE_ROLE_KEY`와 `NEXT_PUBLIC_SUPABASE_URL`이 설정되어 있어야 하며, 로컬에서 호출해도 운영 DB가 갱신됩니다. 가능한 확인 방법은 다음과 같습니다.

1) 로컬에서 서버 실행: `npm run dev`
2) 별도 터미널에서 호출:
   `curl -H "x-cron-secret: <CRON_SECRET>" http://localhost:3000/api/cafe24/refresh`

원하시면 로컬 전용 보호 키(`CRON_SECRET`)로만 동작하도록 먼저 구현한 뒤, 실제 갱신은 테스트 계정으로 제한하는 옵션도 추가할 수 있습니다. 진행할까요?

# 질문
현재 서비스에서 cafe24를 통해 쇼핑몰을 운영하는 사람을 대상으로 24시간 자동 AI CS서비스를 제공하고자 합니다.
이때 사용자는 어떤 정보를 입력해야 cafe24의 주문, 고객 정보 등을 서비스에서 인지할 수 있도록 할 수 있나요?

# 답변
Cafe24의 주문/고객 정보를 서비스에서 조회하려면 **OAuth 기반 연동 정보**가 필요합니다. 사용자가 입력(또는 승인)해야 하는 핵심 항목은 아래입니다.

1) **쇼핑몰 식별 정보**
- `mall_id` (카페24 쇼핑몰 아이디)

2) **앱 인증 정보(서비스 쪽에서 보유)**
- `client_id` (App Key)
- `client_secret` (App Secret)
- `redirect_uri` (OAuth 콜백 주소)

3) **관리자 계정으로 OAuth 승인**
- 쇼핑몰 소유(또는 권한 있는) 관리자 계정 로그인
- 주문/고객/배송 등 필요한 **권한 범위(scope)** 동의

4) **발급된 토큰 정보**
- `access_token`
- `refresh_token`
- `expires_at` (만료 시각)

위 4가지가 확보되면, 서비스가 Cafe24 API로 주문/고객 정보를 조회할 수 있습니다.  
운영 관점에서는 **토큰 갱신 주기 관리(자동 refresh)** 가 필수입니다.
