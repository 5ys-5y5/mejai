#질문
답변 로직 흐름이 "src/app/api/playground/chat/route.ts"에서 기록되어져 가고 있는 것을 확인하였습니다.

그렇다면 사용자가 KB를 에이전트에 연결하고, admin이 공통 KB를 연결했다면 src/app/api/playground/chat/route.ts 파일에 대한 기준이 업데이트되어 답변하는 형태인가요?

KB의 룰은 어떻게 반영되나요?

`src/app/api/playground/chat/route.ts`에 `isAbusive()`라는 함수가 없을 때 KB에 "욕설 대응/반복 질문 금지/배송지 변경 확정 시 티켓 생성"이라는 항목이 있다면 이를 어떻게 답변에 구현하는지 알고 싶습니다.

# 답변
요약하면, KB는 "프롬프트 지침"으로만 반영되고, 코드에 없는 행동(욕설 처리/티켓 생성/반복 질문 차단)은 자동으로 실행되지 않습니다.

1) KB 연결 시 답변 기준이 업데이트되는가?
- 네. `/app/agents/{id}/playground`에서 에이전트가 연결한 KB + ADMIN 공통 KB가 `src/app/api/playground/chat/route.ts`에서 로드되어 LLM 프롬프트에 들어갑니다.
- 하지만 이는 "텍스트 지침" 반영이며, 코드 로직 자체(분기/툴 호출)는 바뀌지 않습니다.

2) KB 룰은 어떻게 반영되나?
- 현재 구조는 "KB 내용을 LLM 입력에 포함"하는 방식입니다.
- 그래서 KB에 "욕설 대응"이 적혀 있으면 LLM이 그 톤/응답을 따라줄 확률이 높아집니다.
- 반대로, “티켓 생성” 같은 행동은 코드가 tool 호출을 수행해야 실제로 실행됩니다.

3) isAbusive()가 없으면 KB만으로 구현 가능한가?
- 부분적으로만 가능합니다. 예를 들면:
  - 욕설 대응: LLM이 사과/정중 답변을 하도록 유도 가능 (품질은 보장 불가)
  - 반복 질문 금지: LLM이 지침을 따를 수도 있지만, 시스템적으로 차단되지는 않음
  - 배송지 변경 확정 시 티켓 생성: KB만으로는 불가. 실제 MCP tool 호출이 없으므로 실행되지 않음

즉, “KB는 규칙을 *말*하게 만들 수 있지만, *행동*을 보장하지 못합니다.”

행동까지 보장하려면
- 코드에 룰 엔진/분기 로직을 추가하거나
- KB를 구조화(rule DSL/JSON)해서 파싱 후 명시적으로 행동 수행

원하시면 “ADMIN KB 규칙 → 시스템 행동”으로 이어지는 룰 엔진(예: 욕설 감지 시 사과 응답 템플릿 강제, 주문번호+주소+확정 시 티켓 자동 생성)을 설계/구현해 드릴게요.
