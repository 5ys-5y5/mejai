# 질문
-- Phase 3: Operator console schema supplements for Mejai
-- Adds required fields and tables per mejai_Guideline (F-B1, event logs, review queue, audit logs)

-- 1) sessions table enhancements
alter table public.sessions
  add column if not exists org_id uuid null;

alter table public.sessions
  add column if not exists started_at timestamp with time zone null;

alter table public.sessions
  add column if not exists duration_sec integer null;

alter table public.sessions
  add column if not exists channel text null;

alter table public.sessions
  add column if not exists caller_masked text null;

alter table public.sessions
  add column if not exists agent_id text null;

alter table public.sessions
  add column if not exists outcome text null;

alter table public.sessions
  add column if not exists sentiment text null;

alter table public.sessions
  add column if not exists recording_url text null;

alter table public.sessions
  add column if not exists session_code text null;

alter table public.sessions
  add column if not exists metadata jsonb null default '{}'::jsonb;

-- 2) turns table enhancements
alter table public.turns
  add column if not exists seq integer null;

alter table public.turns
  add column if not exists start_time text null;

alter table public.turns
  add column if not exists end_time text null;

alter table public.turns
  add column if not exists asr_confidence real null;

alter table public.turns
  add column if not exists confirmation_response text null;

alter table public.turns
  add column if not exists final_answer text null;

alter table public.turns
  add column if not exists turn_code text null;

-- 3) audio_segments table
create table if not exists public.audio_segments (
  id uuid not null default gen_random_uuid(),
  session_id uuid null,
  label text null,
  start_time text null,
  end_time text null,
  audio_url text null,
  created_at timestamp with time zone null default now(),
  constraint audio_segments_pkey primary key (id),
  constraint audio_segments_session_id_fkey foreign key (session_id) references public.sessions (id) on delete cascade
);

-- 4) event_logs table
create table if not exists public.event_logs (
  id uuid not null default gen_random_uuid(),
  session_id uuid null,
  event_type text not null,
  payload jsonb null default '{}'::jsonb,
  created_at timestamp with time zone null default now(),
  constraint event_logs_pkey primary key (id),
  constraint event_logs_session_id_fkey foreign key (session_id) references public.sessions (id) on delete cascade
);

-- 5) review_queue table
create table if not exists public.review_queue (
  id uuid not null default gen_random_uuid(),
  session_id uuid null,
  reason text null,
  owner text null,
  status text null default 'Open',
  created_at timestamp with time zone null default now(),
  constraint review_queue_pkey primary key (id),
  constraint review_queue_session_id_fkey foreign key (session_id) references public.sessions (id) on delete cascade
);

-- 6) audit_logs table
create table if not exists public.audit_logs (
  id uuid not null default gen_random_uuid(),
  actor text null,
  action text null,
  target text null,
  created_at timestamp with time zone null default now(),
  constraint audit_logs_pkey primary key (id)
);

-- 7) foreign key for sessions.org_id
alter table public.sessions
  add constraint if not exists sessions_org_id_fkey foreign key (org_id) references public.organizations (id) on delete cascade;

-- 8) indexes
create index if not exists sessions_created_at_idx on public.sessions (created_at);
create index if not exists sessions_org_id_idx on public.sessions (org_id);
create index if not exists turns_session_id_idx on public.turns (session_id);
create index if not exists event_logs_session_id_idx on public.event_logs (session_id);
create index if not exists review_queue_session_id_idx on public.review_queue (session_id);

위 코드를 supabase의 sql쿼리 실행시 아래 에러가 발생합니다.
Error: Failed to run sql query: ERROR: 42601: syntax error at or near "not" LINE 108: add constraint if not exists sessions_org_id_fkey foreign key (org_id) references public.organizations (id) on delete cascade; ^

# 답변
원인은 Postgres에서 `ADD CONSTRAINT IF NOT EXISTS` 문법을 지원하지 않기 때문입니다.
아래 DO 블록으로 교체해서 실행해 주세요.

```sql
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'sessions_org_id_fkey'
  ) THEN
    ALTER TABLE public.sessions
      ADD CONSTRAINT sessions_org_id_fkey
      FOREIGN KEY (org_id) REFERENCES public.organizations (id) ON DELETE CASCADE;
  END IF;
END $$;
```

이미 수정된 패치 파일도 있습니다.
- `docs/supabase_schema_patch.sql`

이 파일을 사용해 전체 스크립트를 다시 실행해 주세요.
