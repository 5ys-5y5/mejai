#질문
MK2 route
/api/playground/chat_mk2
세션 9eecff5d-8722-4d07-a6f9-980fffbf9b86
보기
배송지 변경
배송지 변경을 위해 새 주소를 알려주세요. 예) 주소: 서울시 ... (가능하면 우편번호 포함)
502
배송지 변경을 위해 새 주소를 알려주세요. 예) 주소: 서울시 ... (가능하면 우편번호 포함)
203호를 502호로
배송지 변경을 위해 새 주소를 알려주세요. 예) 주소: 서울시 ... (가능하면 우편번호 포함)
(08813) 서울 관악구 신림동 1515-7 502
배송지 변경을 위해 새 주소를 알려주세요. 예) 주소: 서울시 ... (가능하면 우편번호 포함)

#답변
원인은 두 가지입니다.

1) 출력 정책 우선순위 병합 버그  
`order_change_need_order_id`(주문번호 필요)보다 `order_change_need_address`(주소 필요)가 나중에 덮어써져서, 주문번호가 없어도 주소만 계속 요구했습니다.  
→ 정책 머지 로직을 수정해 **상위 우선순위 forcedResponse가 유지**되도록 고쳤습니다.

2) 주소 추출이 “주소/배송지” 키워드에만 의존  
키워드가 없는 정상 주소 입력(예: “(08813) 서울 관악구…”)을 address로 인식하지 못했습니다.  
→ **우편번호/행정구역 토큰(시/구/동/로/길 등)**이 있으면 키워드 없이도 주소로 인식하도록 개선했습니다.

수정된 파일
- `src/lib/policyEngine.ts` (forcedResponse 우선순위 유지)
- `src/app/api/playground/chat/route_mk2.ts` (주소 추출 보강)

이제 다음 흐름으로 다시 테스트하면 됩니다.
1) “배송지 변경”
2) “휴대폰 번호” 또는 “주문번호”
3) 주소 입력 (키워드 없어도 인식됨)

원하시면 주문번호 선택(1번/2번)까지 포함한 end-to-end 테스트 시나리오도 같이 정리해드리겠습니다.
