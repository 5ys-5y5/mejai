#질문
C:\dev\1227\mejai\docs\policy_gate_design.md 파일에 기록되어 있습니다.

문서를 확인하고 에이전트의 답변 성능을 개선할 수 있도록 설계를 반영해주세요.

# 답변
policy_gate_design.md 내용을 반영해 정책 KB(policy_pack) 기반 Gate(입력/툴/출력)를 추가했습니다. 이제 "관리자 정책 KB + content_json"만 업데이트해도 답변 제어가 가능하도록 최소한의 하드코딩으로 동작합니다.

적용 내용(핵심)
- 정책 엔진 추가: `src/lib/policyEngine.ts`
  - policy_pack의 rules/templates/tool_policies를 로딩
  - input/tool/output gate 실행
  - deny/allow/force tool, template 강제 응답, 출력 포맷 강제 지원
- playground 답변 흐름에 Gate 적용: `src/app/api/playground/chat/route.ts`
  - admin 정책 KB(kb_kind=policy_pack, content_json) 로딩
  - apply_groups/apply_groups_mode 필터 적용
  - Input Gate: 강제 응답/도구 금지/반복 제한 등 수행
  - Tool Gate: 툴 호출 강제/차단/검증
  - Output Gate: 응답 포맷 강제
- 정책 KB 저장 지원 확장
  - `src/app/api/kb/route.ts`: kb_kind/content_json 저장
  - `src/app/api/kb/[id]/route.ts`: kb_kind/content_json 변경 시 버전 생성

하드코딩이 불가피한 부분(가이드)
- 새 predicate가 추가될 때: `src/lib/policyEngine.ts`의 `matchPredicate()`에 로직 추가 필요
  - 예: text.contains_abuse, entity.order_id.present, intent.is 등
- 새 action 타입이 추가될 때: `applyActions()`에 실행 로직 추가 필요
  - 예: force_response_template, deny_tools, force_tool_call 등
- 이는 “행동 보장”을 위해 Gate에서 반드시 필요합니다. KB만으로는 실행/차단을 보장할 수 없습니다.

운영 방법
1) admin 정책 KB 생성 (knowledge_base)
   - is_admin=true, kb_kind='policy_pack', content_json에 JSON 규칙 저장
2) apply_groups/apply_groups_mode로 적용 대상 필터 설정
3) playground에서 정책 반영 확인

DB 전제
- policy_gate_design.md에 적힌 컬럼(kb_kind, content_json) 사용
- 기존 admin 공통 KB는 텍스트 정책(톤/문구)으로 사용, policy_pack은 행동 제어에 사용

추가 확인 필요
- policy_pack 템플릿/룰 JSON의 실제 스키마 확정(현재는 설계 초안 기반 지원)
- 필요한 predicate/action 리스트 확정 시, registry에 추가

적용 파일
- `src/lib/policyEngine.ts`
- `src/app/api/playground/chat/route.ts`
- `src/app/api/kb/route.ts`
- `src/app/api/kb/[id]/route.ts`
