#질문
지금까지의 맥락을 확인하고, http://localhost:3000/app/agents/%7Bid%7D/playground에서 LLM이 답변하는 규칙을 정리해서 답변해주세요.

KB를 업데이트하고자 합니다.
현재 욕설에 대한 대응, 반복 질문 금지와 같은 기준은 어디에 기록되고 있는지도 알려주세요

# 답변
아래는 현재 playground에서 LLM 답변이 생성되는 규칙과 위치입니다.

LLM 답변 규칙(핵심 요약)
- 에이전트에 연결된 KB만 사용 (AGENT_KB_MISSING/KB_NOT_ACTIVE면 중단)
- ADMIN 공통 KB가 있으면 사용자 그룹 매칭 후 추가 적용
- 요약/확인 질문은 자연스러운 1문장, 숫자/목록/"고객" 표현 금지
- 주문/배송/환불/변경 의도 판단 후 필요한 정보(주문번호/주소/휴대폰) 수집
- 주문번호+주소가 있으면 즉시 변경 확인 질문
- 주문번호 없이 시작하면 휴대폰 번호 요청 → 최근 주문 리스트 제시
- 욕설 입력 시 사과 + 정보 요청으로 전환(확인 질문 반복 금지)
- MCP 처리 결과를 반영해 최종 답변 생성
- 최종 답변 형식: 요약 → 근거 → 상세 → 다음 액션

적용 코드 위치
- 답변 로직/흐름: `src/app/api/playground/chat/route.ts`
- MCP 호출/정책: `src/lib/mcpAdapters.ts`, `src/lib/mcpPolicy.ts`
- KB 생성/버전/임베딩: `src/app/api/kb/route.ts`, `src/app/api/kb/[id]/route.ts`

욕설/반복 질문 금지 기준이 기록되는 위치
- 현재는 코드 룰로 구현되어 있음: `src/app/api/playground/chat/route.ts`
  - 욕설 감지: `isAbusive()`
  - 반복 확인 질문 회피: 주문번호/주소/휴대폰 맥락 재구성 + 확인 루프 회피 로직
- ADMIN 공통 KB에도 동일 규칙을 문서로 기록 가능 (공통 KB로 추가하면 프롬프트에 삽입됨)

KB 업데이트 가이드
- 일반 KB: `/app/kb/new`에서 생성 → 에이전트에 연결
- ADMIN 공통 KB: admin 계정으로 생성 시 "ADMIN 공통 KB" 선택
  - 적용 대상은 user_access.group 기준으로 "모두 포함"/"하나라도 포함" 설정 가능
  - 생성 후에는 유형/대상 변경 불가

원하시면 ADMIN 공통 KB 템플릿(욕설 대응/반복 질문 금지/배송지 변경 확정 시 티켓 생성)을 작성해 드리겠습니다.
