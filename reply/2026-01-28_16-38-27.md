# 질문
1. 서버에서 SDK만 사용하고, 문제 생기면 그때 REST 백업을 고려한다. (우리는 서버 개발 언어가 뭐죠? (Node.js / Python / Java 등) 그 언어에 맞는 공식 SDK를 쓰면 끝입니다.)
2. WebSocket로 구현 (추후 실시간 전화가 핵심 기능이기 때문)
3. 본 서비스는 플랫폼으로 KB는 유저마다 서로 다른 문서가 저장됩니다. 따라서 수동 업로드형이며 사용자가 활성화한 KB(knowledge_base 테이블의 is_active 컬럼이 true인 경우)를 사용하는 것으로 함
4. 현재 MCP 구현 상태를 보고 알아서 결정할 것
5. mejai_Guideline.md 문서와 아래 실제로 저장된 내용들을 보고 구성 방식을 판단할 것

turns 테이블
id,session_id,created_at,audio_url,transcript_text,summary_text,confirm_prompt,user_confirmed,correction_text,answer_text,kb_references,seq,start_time,end_time,asr_confidence,confirmation_response,final_answer,turn_code
244b66db-4596-4c39-80de-8f209a49552b,6422ebc9-06e8-4ce0-a044-830207183ff5,2026-01-22 13:03:31.597543+00,,주문번호는 8841입니다.,환불 상태 문의. 주문번호 8841 확인 후 안내.,주문번호 8841로 조회해도 될까요?,,,담당자에게 이관하여 확인 후 안내드리겠습니다.,[],3,00:49,01:12,0.94,"네, 맞아요.",담당자에게 이관하여 확인 후 안내드리겠습니다.,
2ace1647-e054-4cb4-98be-543f6e6898d1,450b8667-bec5-481d-aa9b-44f2ada02422,2026-01-26 01:37:16.394789+00,,주문번호는 8841입니다.,환불 상태 문의. 주문번호 8841 확인 후 안내.,주문번호 8841로 조회해도 될까요?,,,담당자에게 이관하여 확인 후 안내드리겠습니다.,[],3,00:49,01:12,0.94,"네, 맞아요.",담당자에게 이관하여 확인 후 안내드리겠습니다.,
35bbf22d-cf81-4cf8-b446-07dc190ca370,6422ebc9-06e8-4ce0-a044-830207183ff5,2026-01-22 13:07:39.193665+00,,,,,,,,[],8,,,,,,
3ba173d3-8314-42e5-88f1-b002e80337ff,450b8667-bec5-481d-aa9b-44f2ada02422,2026-01-26 01:37:16.394789+00,,환불 진행 상황을 알고 싶습니다.,,환불 진행 상황을 확인해 드려도 될까요?,,,환불 상태를 조회 중입니다.,[],2,00:19,00:48,0.9,"네, 맞습니다.",,
3da4f69d-c985-435d-bf84-65f4f9f27647,6422ebc9-06e8-4ce0-a044-830207183ff5,2026-01-22 13:03:31.597543+00,,안녕하세요. 상담 도움을 요청합니다.,,,,,문의 내용을 확인했습니다. 잠시만 기다려 주세요.,[],1,00:00,00:18,0.92,,,
4498e24d-26e0-4a80-9968-9a85ee05982c,da2765bb-b21f-4048-8213-411f33654000,2026-01-22 12:33:19.736828+00,,환불 진행 상황을 알고 싶습니다.,,환불 진행 상황을 확인해 드려도 될까요?,,,환불 상태를 조회 중입니다.,[],2,00:19,00:48,0.9,"네, 맞습니다.",,
56de0491-c77c-458b-9eb4-483101f6181f,6422ebc9-06e8-4ce0-a044-830207183ff5,2026-01-22 13:07:22.993222+00,,고객이 환불 진행 상황을 문의했습니다.,,,,,,[],4,00:00,00:08,0.93,,,
5afb43cd-a364-47c6-a329-0f30c2ab79be,ce1a2fba-5012-4689-b40d-94dc0c3437be,2026-01-22 12:22:01.734699+00,,환불 진행 상황을 알고 싶습니다.,,환불 진행 상황을 확인해 드려도 될까요?,,,환불 상태를 조회 중입니다.,[],2,00:19,00:48,0.9,"네, 맞습니다.",,
65be1164-dcb6-4ef0-acab-061a12a1004e,6422ebc9-06e8-4ce0-a044-830207183ff5,2026-01-22 13:08:27.461997+00,,,,,,,,[],10,,,,,환불 처리가 진행 중이며 1~2영업일 내 완료됩니다.,
6762045f-8f0b-464e-91c6-339eaa24bf10,ce1a2fba-5012-4689-b40d-94dc0c3437be,2026-01-22 12:22:01.734699+00,,안녕하세요. 상담 도움을 요청합니다.,,,,,문의 내용을 확인했습니다. 잠시만 기다려 주세요.,[],1,00:00,00:18,0.92,,,
7144c70e-812b-4fe7-acd3-eaff91ff9420,da2765bb-b21f-4048-8213-411f33654000,2026-01-22 12:33:19.736828+00,,안녕하세요. 상담 도움을 요청합니다.,,,,,문의 내용을 확인했습니다. 잠시만 기다려 주세요.,[],1,00:00,00:18,0.92,,,
758a9149-a9d9-41b9-a767-a2754150312a,da2765bb-b21f-4048-8213-411f33654000,2026-01-22 12:33:19.736828+00,,주문번호는 8841입니다.,환불 상태 문의. 주문번호 8841 확인 후 안내.,주문번호 8841로 조회해도 될까요?,,,담당자에게 이관하여 확인 후 안내드리겠습니다.,[],3,00:49,01:12,0.94,"네, 맞아요.",담당자에게 이관하여 확인 후 안내드리겠습니다.,
7e1f257d-aef9-45c2-8170-c26c70d2b15e,6422ebc9-06e8-4ce0-a044-830207183ff5,2026-01-22 13:09:58.723537+00,,,,,,,,[],12,,,,,,
809d0822-a201-4749-92f3-1f904c7a56bc,6422ebc9-06e8-4ce0-a044-830207183ff5,2026-01-22 13:08:34.302705+00,,,,주문번호 8841로 조회해도 될까요?,,,,[],11,,,,,,
839c3574-9923-4630-8c96-74d11240b06d,ce1a2fba-5012-4689-b40d-94dc0c3437be,2026-01-22 12:22:01.734699+00,,주문번호는 8841입니다.,환불 상태 문의. 주문번호 8841 확인 후 안내.,주문번호 8841로 조회해도 될까요?,,,담당자에게 이관하여 확인 후 안내드리겠습니다.,[],3,00:49,01:12,0.94,"네, 맞아요.",담당자에게 이관하여 확인 후 안내드리겠습니다.,
8e48747d-954e-4724-b24a-b7bd5ce23136,6422ebc9-06e8-4ce0-a044-830207183ff5,2026-01-22 13:03:31.597543+00,,환불 진행 상황을 알고 싶습니다.,,환불 진행 상황을 확인해 드려도 될까요?,,,환불 상태를 조회 중입니다.,[],2,00:19,00:48,0.9,"네, 맞습니다.",,
ac46c441-4a7d-42f5-a377-13860fa43117,450b8667-bec5-481d-aa9b-44f2ada02422,2026-01-26 01:37:16.394789+00,,안녕하세요. 상담 도움을 요청합니다.,,,,,문의 내용을 확인했습니다. 잠시만 기다려 주세요.,[],1,00:00,00:18,0.92,,,
ad2f58e7-e96f-462f-9237-4c82555c830b,6422ebc9-06e8-4ce0-a044-830207183ff5,2026-01-22 13:07:34.729778+00,,,,,,,,[],7,,,,,환불 처리가 진행 중이며 1~2영업일 내 완료됩니다.,
f0ae8e12-2e36-4a02-ae2a-6d755f4fcdc6,6422ebc9-06e8-4ce0-a044-830207183ff5,2026-01-22 13:07:28.726177+00,,,환불 진행 상태 문의. 주문번호 확인 필요.,,,,,[],5,,,,,,
f371cfe3-f6b0-43b0-bd82-3a6059b7191c,6422ebc9-06e8-4ce0-a044-830207183ff5,2026-01-22 13:07:32.234008+00,,,,주문번호 8841로 조회해도 될까요?,,,,[],6,,,,,,
f407d2bf-da7c-4b0a-aa58-79ad61042f2e,6422ebc9-06e8-4ce0-a044-830207183ff5,2026-01-22 13:07:58.606785+00,,,환불 진행 상태 문의. 주문번호 확인 필요.,,,,,[],9,,,,,,

sessions 테이블
id,created_at,ended_at,phone_number,category,satisfaction,is_escalated,escalation_reason,metadata,org_id,started_at,duration_sec,channel,caller_masked,agent_id,outcome,sentiment,recording_url,session_code
450b8667-bec5-481d-aa9b-44f2ada02422,2026-01-26 01:37:16.23134+00,2026-01-26 01:37:19.417+00,,,2,false,사람 상담 필요,{},8ad81b6b-3210-40dd-8e00-9a43a4395923,2026-01-26 01:31:59.417+00,320,유선,+82-10-****-5678,a_support,이관,불만,,s_gd1bgu
6422ebc9-06e8-4ce0-a044-830207183ff5,2026-01-22 13:03:31.423781+00,2026-01-22 13:03:31.414+00,,,2,false,사람 상담 필요,{},22f58308-d6de-486d-9b08-a7f6461854b3,2026-01-22 12:58:11.414+00,320,유선,+82-10-****-5678,a_support,이관,불만,,s_0o6s0c
ce1a2fba-5012-4689-b40d-94dc0c3437be,2026-01-22 12:22:01.562263+00,2026-01-22 12:22:01.502+00,,,2,false,사람 상담 필요,{},22f58308-d6de-486d-9b08-a7f6461854b3,2026-01-22 12:16:41.502+00,320,유선,+82-10-****-5678,a_support,이관,불만,,s_96m6a6
da2765bb-b21f-4048-8213-411f33654000,2026-01-22 12:33:19.559112+00,2026-01-22 12:33:19.498+00,,,2,false,사람 상담 필요,{},22f58308-d6de-486d-9b08-a7f6461854b3,2026-01-22 12:27:59.498+00,320,유선,+82-10-****-5678,a_support,이관,불만,,s_b9dv4b

review_queue 테이블
id,session_id,reason,owner,status,created_at
1d7038b7-4e1b-47a0-87d2-d74db4e0437d,6422ebc9-06e8-4ce0-a044-830207183ff5,후속 지원 요청,미배정,Open,2026-01-22 13:07:39.690262+00
4489f37f-5682-40a7-8718-62b4723fed9e,ce1a2fba-5012-4689-b40d-94dc0c3437be,후속 지원 요청,미배정,Open,2026-01-22 12:22:02.517537+00
5a79b54a-05bd-4ae7-b297-a63c1e2f0526,da2765bb-b21f-4048-8213-411f33654000,후속 지원 요청,미배정,Open,2026-01-22 12:33:20.289266+00
689faa32-af5e-4e4f-884b-c1fdf9ca3de3,6422ebc9-06e8-4ce0-a044-830207183ff5,후속 지원 요청,미배정,Open,2026-01-22 13:03:32.084667+00
6dcb8f5e-b24d-4757-aa74-d2c00d4966e4,6422ebc9-06e8-4ce0-a044-830207183ff5,후속 지원 요청,미배정,Open,2026-01-22 13:09:59.207487+00
7040bf19-254e-47b2-857e-2c6450b61058,450b8667-bec5-481d-aa9b-44f2ada02422,후속 지원 요청,미배정,Open,2026-01-26 01:37:16.91779+00

event_logs 테이블
id,session_id,event_type,payload,created_at
05d057b4-9acb-434c-bf39-e7b027bc1ab4,6422ebc9-06e8-4ce0-a044-830207183ff5,FINAL_ANSWER_READY,"{""seq"": 10, ""step"": ""final"", ""outcome"": ""해결"", ""final_answer"": ""환불 처리가 진행 중이며 1~2영업일 내 완료됩니다.""}",2026-01-22 13:08:27.641317+00
0620e984-7b1c-4c27-9ea2-f8a42146a4c4,6422ebc9-06e8-4ce0-a044-830207183ff5,SUMMARY_GENERATED,"{""summary"": ""환불 상태 문의. 주문번호 8841 확인 후 안내.""}",2026-01-22 13:03:31.765088+00
111407c0-d53d-4e3b-abb9-f467a3389287,6422ebc9-06e8-4ce0-a044-830207183ff5,ESCALATED,"{""seq"": 12, ""step"": ""escalate"", ""escalation_reason"": ""사람 상담 필요""}",2026-01-22 13:09:58.884819+00
17da5e4c-803a-404a-b964-3e0c3a6ebbdf,ce1a2fba-5012-4689-b40d-94dc0c3437be,SUMMARY_GENERATED,"{""summary"": ""환불 상태 문의. 주문번호 8841 확인 후 안내.""}",2026-01-22 12:22:02.173309+00
1d3a6f85-5d2c-4712-98a5-086d7fdd548c,ce1a2fba-5012-4689-b40d-94dc0c3437be,FINAL_ANSWER_READY,"{""answer"": ""담당자에게 이관하여 확인 후 안내드리겠습니다.""}",2026-01-22 12:22:02.173309+00
26d6a1d8-351b-4930-a6fb-6c0b948a0bd7,6422ebc9-06e8-4ce0-a044-830207183ff5,FINAL_ANSWER_READY,"{""answer"": ""담당자에게 이관하여 확인 후 안내드리겠습니다.""}",2026-01-22 13:03:31.765088+00
2cf59afe-ab41-4594-adfc-cabf47bc9606,6422ebc9-06e8-4ce0-a044-830207183ff5,FINAL_ANSWER_READY,"{""seq"": 7, ""step"": ""final"", ""outcome"": ""해결"", ""final_answer"": ""환불 처리가 진행 중이며 1~2영업일 내 완료됩니다.""}",2026-01-22 13:07:34.897815+00
30b7302e-8574-47c3-b3fb-52b30f5d3136,6422ebc9-06e8-4ce0-a044-830207183ff5,SUMMARY_GENERATED,"{""seq"": 9, ""step"": ""summary"", ""summary_text"": ""환불 진행 상태 문의. 주문번호 확인 필요.""}",2026-01-22 13:07:58.770667+00
327ed478-3aca-4dcb-92f2-89555e2aa969,da2765bb-b21f-4048-8213-411f33654000,FINAL_ANSWER_READY,"{""answer"": ""담당자에게 이관하여 확인 후 안내드리겠습니다.""}",2026-01-22 12:33:19.920617+00
3731889f-4c6d-44e0-b0c5-09414dd0233b,da2765bb-b21f-4048-8213-411f33654000,ESCALATED,"{""reason"": ""사람 상담 필요""}",2026-01-22 12:33:19.920617+00
40717ca8-8968-407e-981c-b8bcf2e661dc,450b8667-bec5-481d-aa9b-44f2ada02422,FINAL_ANSWER_READY,"{""answer"": ""담당자에게 이관하여 확인 후 안내드리겠습니다.""}",2026-01-26 01:37:16.562905+00
44fff472-b35f-49e3-908d-2b7bd5ae832b,450b8667-bec5-481d-aa9b-44f2ada02422,SUMMARY_GENERATED,"{""summary"": ""환불 상태 문의. 주문번호 8841 확인 후 안내.""}",2026-01-26 01:37:16.562905+00
573b5ca8-9b37-437c-98b2-eb5be156c37a,6422ebc9-06e8-4ce0-a044-830207183ff5,CONFIRMATION_REQUESTED,"{""seq"": 6, ""step"": ""confirm"", ""confirm_prompt"": ""주문번호 8841로 조회해도 될까요?""}",2026-01-22 13:07:32.402604+00
57e1aae2-38ab-4641-99e4-11476b0c9ae0,6422ebc9-06e8-4ce0-a044-830207183ff5,ESCALATED,"{""reason"": ""사람 상담 필요""}",2026-01-22 13:03:31.765088+00
614adba3-7b2d-405f-812f-f00a78d88c32,450b8667-bec5-481d-aa9b-44f2ada02422,ESCALATED,"{""reason"": ""사람 상담 필요""}",2026-01-26 01:37:16.562905+00
9f223fc4-a774-4a37-95b3-2e124d2a2cc2,6422ebc9-06e8-4ce0-a044-830207183ff5,ESCALATED,"{""seq"": 8, ""step"": ""escalate"", ""escalation_reason"": ""사람 상담 필요""}",2026-01-22 13:07:39.352475+00
a0476711-b0a9-422f-ae0d-11bd3d55d3af,6422ebc9-06e8-4ce0-a044-830207183ff5,SUMMARY_GENERATED,"{""seq"": 5, ""step"": ""summary"", ""summary_text"": ""환불 진행 상태 문의. 주문번호 확인 필요.""}",2026-01-22 13:07:28.890509+00
a7d6e353-2025-4313-acd7-438afb187737,da2765bb-b21f-4048-8213-411f33654000,SUMMARY_GENERATED,"{""summary"": ""환불 상태 문의. 주문번호 8841 확인 후 안내.""}",2026-01-22 12:33:19.920617+00
d601a4c8-45cf-437c-b4aa-647aca9fefef,6422ebc9-06e8-4ce0-a044-830207183ff5,ASR_RECEIVED,"{""seq"": 4, ""step"": ""asr"", ""end_time"": ""00:08"", ""start_time"": ""00:00"", ""asr_confidence"": 0.93, ""transcript_text"": ""고객이 환불 진행 상황을 문의했습니다.""}",2026-01-22 13:07:23.153544+00
dd53f2c4-11f7-4b96-b86f-262f0604d58e,ce1a2fba-5012-4689-b40d-94dc0c3437be,ESCALATED,"{""reason"": ""사람 상담 필요""}",2026-01-22 12:22:02.173309+00
f126697d-381f-42fd-9080-15387c619be4,6422ebc9-06e8-4ce0-a044-830207183ff5,CONFIRMATION_REQUESTED,"{""seq"": 11, ""step"": ""confirm"", ""confirm_prompt"": ""주문번호 8841로 조회해도 될까요?""}",2026-01-22 13:08:34.490074+00

audio_segments 테이블
id,session_id,label,start_time,end_time,audio_url,created_at
4bcfb3ee-32c5-4a25-b4fe-13827d514946,6422ebc9-06e8-4ce0-a044-830207183ff5,인사,00:00,00:10,,2026-01-22 13:03:31.921258+00
5e3efbdd-effe-47c1-9bf3-1eec4a5a4200,6422ebc9-06e8-4ce0-a044-830207183ff5,주문번호 확인,00:49,01:05,,2026-01-22 13:03:31.921258+00
7cda8acc-b3e3-4ce4-9d42-9cafc6c9d29e,450b8667-bec5-481d-aa9b-44f2ada02422,인사,00:00,00:10,,2026-01-26 01:37:16.734713+00
809ce70b-436c-4c87-b024-2ed082eeda96,da2765bb-b21f-4048-8213-411f33654000,주문번호 확인,00:49,01:05,,2026-01-22 12:33:20.085136+00
89403ede-4dec-493b-9db8-49ed98e6b17d,ce1a2fba-5012-4689-b40d-94dc0c3437be,주문번호 확인,00:49,01:05,,2026-01-22 12:22:02.350392+00
bf116c7c-8683-423d-a409-2df7b383e04a,450b8667-bec5-481d-aa9b-44f2ada02422,주문번호 확인,00:49,01:05,,2026-01-26 01:37:16.734713+00
dc02fece-e9e6-489b-8282-898458315915,ce1a2fba-5012-4689-b40d-94dc0c3437be,인사,00:00,00:10,,2026-01-22 12:22:02.350392+00
e55ea5f4-03e5-48d0-b8f6-1be4a49caa37,da2765bb-b21f-4048-8213-411f33654000,인사,00:00,00:10,,2026-01-22 12:33:20.085136+00

위 테이블은 agent, MCP 테이블이 생성되기 전에 생성된 테이블들로 각 대화가 어떤 KB와 어떤 agent, 어떤 MCP 버전에 의해서 기록되었는지 연결이 되어야 함.

기본적으로 agent 버전이 agent 테이블에서 관리되며 각 버전에서 어떤 MCP와 KB를 사용하였는지 기록되고 각 대화나 조치 사항 등이 어떤 에이전트 버전에서 발생하였는지 연결 할 것

#답변
확인했습니다. 서버는 현재 Next.js 기반이므로 백엔드는 Node.js로 보고 공식 SDK(OpenAI/Gemini)로 구현하겠습니다. 스트리밍은 WebSocket으로 통일하고, KB는 org_id + is_active 기준으로만 검색하도록 구성합니다. MCP는 현재 구현 상태를 기준으로 스키마 검증/정책/감사로그 흐름을 맞추겠습니다. mejai_Guideline과 실제 저장 샘플을 기준으로 turns/event_logs/sessions 기록 형태를 정하겠습니다.

연결 방식 제안(에이전트/KB/MCP 버전 추적)
- 권장 스키마 확장: sessions/turns/event_logs/review_queue/audio_segments에 agent_version_id(=agent.id), kb_version_id(=knowledge_base.id), mcp_tool_version_id(또는 mcp_tool_audit_logs 연결 키) 컬럼 추가
- turns.kb_references에는 {kb_id, title, version, chunk_id, score} 형태로 저장
- mcp_tool_audit_logs에 agent_version_id, session_id, tool_version_id를 기록하여 tool 호출과 대화 버전 연결
- event_logs.payload에는 step별로 agent_version_id/kb_version_id를 함께 기록

바로 구현을 시작하기 전에 필요한 결정 2가지
1) DB 마이그레이션은 제가 SQL까지 작성해도 되는지, 아니면 Supabase 콘솔에서 수동 적용할지
2) 위 스키마 확장 대신 metadata(jsonb)로만 기록해도 되는지, 컬럼을 반드시 추가할지

확정해 주시면 LLM/MCP/KB 통합 구현과 함께 버전 추적까지 바로 반영하겠습니다.
