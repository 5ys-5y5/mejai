#질문
http://localhost:3000/app/kb/new 페이지의 Policy JSON 구현 방식을 고도화 하고자 합니다.

1. C:\dev\1227\mejai\src\app\api\playground\chat\route.ts 파일과 C:\dev\1227\mejai\src\lib\llm.ts 파일에 구현되어 있는 모든 사항을 Policy JSON *에 "선택시 추가 가능한 방식"으로 구현해야 합니다.

2. 선택시 추가 가능한 방식이라 함은, 규칙, 템플, 툴 정책 별로 위 파일들에 존재하는 모든 항목 중에 사용자가 단순 클릭으로 어떤 요소가 반영될 예정인지 직관적으로 볼 수 있어야 합니다. (현재 JSON 으로 입력하도록 되어 있는데 이는 전혀 직관적이지 않아 헷갈립니다. 버튼을 누르면 자동으로 JSON 양식으로 변환하면 되며, 버튼 선택 영역과 JSON출력 영역을 나누어 모두 출력하면 됩니다)

3. 기존에 없던 새로운 값은 규칙 추가 버튼 클릭 후 "텍스트 인풋(예시와 함께)"에 값을 입력하고 등록하면 해당 항목은 하드 코딩이 필요한 항목일 경우 경고 아이콘과 함께 등록되면 됩니다.

# 답변
요청사항을 반영해 Policy JSON 생성 UI를 고도화했습니다. 이제 규칙/템플릿/툴 정책을 체크박스로 선택하면 JSON이 자동 생성되며, 커스텀 규칙 추가 시 하드코딩 필요 여부를 경고 아이콘으로 표시합니다.

변경 내용
- Policy JSON 선택 UI 추가 (규칙/템플릿/툴 정책 체크박스)
- 선택 결과를 JSON으로 자동 생성하여 출력 영역에 표시
- 커스텀 규칙 입력(예시 포함) + 하드코딩 필요 시 경고 아이콘 표시
- JSON 출력 영역과 선택 영역을 분리

수정 파일
- `src/app/app/kb/new/page.tsx`

Policy JSON 초안(붙여넣기용)
{
  "rules": [
    {
      "id": "R001_abuse",
      "stage": "input",
      "priority": 1000,
      "when": {
        "any": [
          { "predicate": "text.contains_abuse" }
        ]
      },
      "enforce": {
        "actions": [
          { "type": "set_flag", "flag": "conversation.abusive", "value": true },
          { "type": "force_response_template", "template_id": "abuse_warn" },
          { "type": "deny_tools", "tools": ["*"] }
        ]
      }
    },
    {
      "id": "R005_repeat_cooldown",
      "stage": "input",
      "priority": 900,
      "when": {
        "any": [
          { "predicate": "conversation.repeat_over", "args": { "count": 2 } }
        ]
      },
      "enforce": {
        "actions": [
          { "type": "force_response_template", "template_id": "repeat_block" }
        ]
      }
    },
    {
      "id": "R010_need_order_id_for_lookup",
      "stage": "tool",
      "priority": 950,
      "when": {
        "all": [
          { "predicate": "intent.is_one_of", "args": { "values": ["shipment", "order_lookup"] } },
          { "predicate": "entity.order_id.missing" }
        ]
      },
      "enforce": {
        "actions": [
          { "type": "deny_tools", "tools": ["lookup_order", "track_shipment"] },
          { "type": "force_response_template", "template_id": "need_order_id" }
        ]
      }
    },
    {
      "id": "R020_address_change_create_ticket",
      "stage": "tool",
      "priority": 920,
      "when": {
        "all": [
          { "predicate": "intent.is", "args": { "value": "change" } },
          { "predicate": "entity.order_id.present" },
          { "predicate": "entity.address.present" },
          { "predicate": "user.confirmed", "args": { "value": true } }
        ]
      },
      "enforce": {
        "actions": [
          {
            "type": "force_tool_call",
            "tool": "create_ticket",
            "args_template": {
              "title": "배송지 변경 요청 - {{entity.order_id}}",
              "content": "배송지 변경 요청: {{entity.address}}\n주문번호: {{entity.order_id}}\n요청: {{input.text}}"
            }
          }
        ]
      }
    },
    {
      "id": "R030_output_format",
      "stage": "output",
      "priority": 800,
      "when": {
        "any": [
          { "predicate": "text.contains_pii" }
        ]
      },
      "enforce": {
        "actions": [
          { "type": "format_output" }
        ]
      }
    }
  ],
  "templates": {
    "abuse_warn": "불편을 드려 죄송합니다. 원활한 안내를 위해 정중한 표현으로 말씀 부탁드립니다. 주문번호나 휴대폰 번호를 알려주시면 바로 확인해 드리겠습니다.",
    "repeat_block": "같은 문의가 반복되고 있습니다. 주문번호/휴대폰 번호 중 하나를 알려주시면 즉시 처리하겠습니다.",
    "need_order_id": "주문 조회를 위해 주문번호가 필요합니다. 주문번호를 알려주세요."
  },
  "tool_policies": {
    "lookup_order": {
      "required_args": ["order_id"],
      "arg_validators": { "order_id": { "regex": "^[0-9]{8}-[0-9]{7}$" } }
    },
    "track_shipment": {
      "required_args": ["order_id"]
    },
    "create_ticket": {
      "required_args": ["title", "content"]
    }
  }
}

하드코딩 필요 영역 안내
- 새 predicate 추가 시: `src/lib/policyEngine.ts`의 matchPredicate()에 구현 필요
- 새 action 타입 추가 시: `src/lib/policyEngine.ts`의 applyActions()에 구현 필요
- UI에서 새 규칙 추가 시, 미지원 predicate/action이면 경고 아이콘이 표시됩니다.
