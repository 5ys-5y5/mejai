# 질문
<image name=[Image #1]><image name=[Image #2]>[Image #2]
mall_id의 돋보기가 전혀 이상한 곳에 위치하고 있습니다.
/html/body/main/div/div/main/div/div/div[2]/div/div[3]/div[3]/label[1]/input 항목 내부에 존재해야 합니다.
/html/body/main/div/div/main/div/div/div[2]/div/div[3]/div[3]/label[1]/button

[Image #1] 
다른 항목들은 내용이 많아져도 인풋 항목이 화면을 뚫고 나가지 않지만 
아래 3개 항목은 그러지 못하고 있습니다.
/html/body/main/div/div/main/div/div/div[2]/div/div[3]/div[1] 항목 하의
/html/body/main/div/div/main/div/div/div[2]/div/div[3]/div[1]/div[2]/div/div/button
/html/body/main/div/div/main/div/div/div[2]/div/div[3]/div[1]/div[2]/button

/html/body/main/div/div/main/div/div/div[2]/div/div[3]/div[2]/label[7]/div/button

# 답변
mall_id 돋보기 버튼을 label 바로 아래 input 내부 우측에 위치하도록 구조를 바꾸고, SelectPopover/MultiSelectPopover 버튼과 텍스트에 min-w-0/flex-1/truncate를 적용해 선택값이 길어져도 너비가 늘어나지 않게 조정했습니다. 추가로 설정 페이지 하단 패딩을 100px로 맞췄습니다.

# 터미널 출력


    Directory: C:\dev\1227\mejai

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d----        2026-01-26  오후 7:41                .cursor
d--h-        2026-01-27  오후 2:39                .git
d----        2026-01-26  오전 9:54                .next
d----        2026-01-27 오후 12:45                docs
d----        2026-01-26  오전 9:53                node_modules
d----        2026-01-26  오전 9:47                public
d----        2026-01-27  오후 6:46                reply
d----        2026-01-26  오후 3:52                scripts(temp)
d----        2026-01-26  오전 9:47                src
-a---        2026-01-27  오후 1:11            667 .env
-a---        2026-01-26  오전 9:47            521 .gitignore
-a---        2026-01-26  오전 9:47            483 eslint.config.mjs
-a---        2026-01-26  오전 9:54            257 next-env.d.ts
-a---        2026-01-26  오전 9:47            140 next.config.ts
-a---        2026-01-26  오전 9:53         246584 package-lock.json
-a---        2026-01-26  오전 9:47            867 package.json
-a---        2026-01-26  오전 9:47            101 postcss.config.mjs
-a---        2026-01-26  오전 9:47           1380 quick_start.md
-a---        2026-01-26  오전 9:47           1486 README.md
-a---        2026-01-26  오전 9:47            717 tsconfig.json


"use client";

import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { useCallback, useEffect, useMemo, useState } from "react";
import { Card } from "@/components/ui/Card";
import { cn } from "@/lib/utils";
import { useHelpPanelEnabled } from "@/hooks/useHelpPanel";
import { getSupabaseClient } from "@/lib/supabaseClient";
import { MultiSelectPopover, SelectPopover, type SelectOption } from "@/components/SelectPopover";
import { ExternalLink, Eye, EyeOff, Search } from "lucide-react";

type TabKey = "profile" | "workspaces" | "team" | "audit" | "env";
type ProviderKey = "cafe24" | "shopify";

type Cafe24ProviderDraft = {
  mall_id: string;
  mall_domain: string;
  client_id: string;
  client_secret: string;
  access_token: string;
  refresh_token: string;
  expires_at: string;
  scope: string;
  shop_no: string;
  board_no: string;
};

type ShopifyProviderDraft = {
  shop_domain: string;
  client_id: string;
  client_secret: string;
  access_token: string;
  scopes: string;
};

const auditSeed = [
  { t: "2026-01-21 10:30", who: "operator@mejai.help", what: "세션 s_9d3f2b 조회" },
  { t: "2026-01-20 18:50", who: "jane@mejai.help", what: "리뷰 rq_01 할당" },
  { t: "2026-01-18 09:02", who: "owner@mejai.help", what: "KB '환불 정책' v3 배포" },
];

const teamSeed = [
  { role: "오너", perms: "모든 권한" },
  { role: "운영자", perms: "통화, KB, 리뷰" },
  { role: "감사자", perms: "읽기 전용, 감사" },
];

export default function SettingsPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const rawTab = (searchParams.get("tab") || "profile").toLowerCase();
  const tab: TabKey = (rawTab === "general" ? "profile" : rawTab) as TabKey;

  const [email, setEmail] = useState("operator@mejai.help");
  const givenName = "성지용";
  const [isAdmin, setIsAdmin] = useState(false);
  const [adminReady, setAdminReady] = useState(false);
  const [envLoading, setEnvLoading] = useState(false);
  const [envError, setEnvError] = useState<string | null>(null);
  const [envSavedAt, setEnvSavedAt] = useState<string | null>(null);
  const [authToken, setAuthToken] = useState<string>("");
  const [activeProvider, setActiveProvider] = useState<ProviderKey>("cafe24");
  const [revealedField, setRevealedField] = useState<string | null>(null);
  const envReadOnly = false;
  const editableCafe24Keys = new Set(["mall_id", "mall_domain", "shop_no", "board_no"]);
  const [shopOptions, setShopOptions] = useState<SelectOption[]>([]);
  const [shopError, setShopError] = useState<string | null>(null);
  const [shopReloadKey, setShopReloadKey] = useState(0);
  const [shopLoading, setShopLoading] = useState(false);
  const [refreshLoading, setRefreshLoading] = useState(false);
  const [cafe24Draft, setCafe24Draft] = useState<Cafe24ProviderDraft>({
    mall_id: "",
    mall_domain: "",
    client_id: "",
    client_secret: "",
    access_token: "",
    refresh_token: "",
    expires_at: "",
    scope: "",
    shop_no: "",
    board_no: "",
  });
  const [shopifyDraft, setShopifyDraft] = useState<ShopifyProviderDraft>({
    shop_domain: "",
    client_id: "",
    client_secret: "",
    access_token: "",
    scopes: "",
  });

  const { enabled: helpPanelEnabled, setEnabled: setHelpPanelEnabled } = useHelpPanelEnabled();

  useEffect(() => {
    let mounted = true;
    const supabase = getSupabaseClient();
    if (!supabase) return () => {};
    supabase.auth.getUser().then(async ({ data }) => {
      if (!mounted) return;
      if (data.user?.email) setEmail(data.user.email);
      if (!data.user) {
        setAdminReady(true);
        return;
      }
      const { data: sessionData } = await supabase.auth.getSession();
      if (sessionData.session?.access_token) {
        setAuthToken(sessionData.session.access_token);
      }
      const { data: access } = await supabase
        .from("user_access")
        .select("is_admin")
        .eq("user_id", data.user.id)
        .maybeSingle();
      if (!mounted) return;
      setIsAdmin(Boolean(access?.is_admin));
      setAdminReady(true);
    });

    const { data: sub } = supabase.auth.onAuthStateChange((_event, session) => {
      if (!mounted) return;
      setEmail(session?.user?.email || "operator@mejai.help");
      setAuthToken(session?.access_token || "");
    });

    return () => {
      mounted = false;
      sub.subscription.unsubscribe();
    };
  }, []);

  const tabs = useMemo(() => {
    const base = [
      { key: "profile", label: "프로필" },
      { key: "workspaces", label: "워크스페이스" },
      { key: "team", label: "팀/권한" },
      { key: "audit", label: "감사로그" },
    ];
    if (isAdmin) {
      base.push({ key: "env", label: "환경 변수" });
    }
    return base;
  }, [isAdmin]);

  const providerOptions = useMemo<SelectOption[]>(
    () => [
      { id: "cafe24", label: "Cafe24" },
      { id: "shopify", label: "Shopify" },
    ],
    []
  );

  const cafe24ScopeOptions = useMemo<SelectOption[]>(
    () =>
      [
        "mall.read_application",
        "mall.write_application",
        "mall.read_category",
        "mall.write_category",
        "mall.read_product",
        "mall.write_product",
        "mall.read_collection",
        "mall.write_collection",
        "mall.read_supply",
        "mall.write_supply",
        "mall.read_personal",
        "mall.write_personal",
        "mall.read_order",
        "mall.write_order",
        "mall.read_community",
        "mall.write_community",
        "mall.read_customer",
        "mall.write_customer",
        "mall.read_notification",
        "mall.write_notification",
        "mall.read_store",
        "mall.write_store",
        "mall.read_promotion",
        "mall.write_promotion",
        "mall.read_design",
        "mall.write_design",
        "mall.read_salesreport",
        "mall.write_salesreport",
        "mall.read_shipping",
        "mall.write_shipping",
        "mall.read_translation",
        "mall.write_translation",
        "mall.read_analytics",
        "mall.read_privacy",
      ].map((item) => ({ id: item, label: item })),
    []
  );

  const boardNoOptions = useMemo<SelectOption[]>(
    () => [
      { id: "1", label: "1", description: "공지사항" },
      { id: "2", label: "2", description: "뉴스/이벤트" },
      { id: "3", label: "3", description: "이용안내 FAQ" },
      { id: "4", label: "4", description: "상품 사용후기" },
      { id: "5", label: "5", description: "자유게시판" },
      { id: "6", label: "6", description: "상품 Q&A" },
      { id: "7", label: "7", description: "자료실" },
      { id: "8", label: "8", description: "갤러리" },
      { id: "9", label: "9", description: "1:1 맞춤상담" },
      { id: "101", label: "101", description: "상품자유게시판" },
      { id: "1001", label: "1001", description: "한줄메모" },
      { id: "1002", label: "1002", description: "자유게시판2" },
      { id: "3001", label: "3001", description: "자유게시판3" },
    ],
    []
  );

  const shopifyScopeOptions = useMemo<SelectOption[]>(
    () =>
      [
        "read_orders",
        "write_orders",
        "read_customers",
        "write_customers",
        "read_products",
        "write_products",
        "read_inventory",
        "write_inventory",
        "read_fulfillments",
        "write_fulfillments",
        "read_locations",
        "read_shipping",
        "write_shipping",
        "read_content",
        "write_content",
      ].map((item) => ({ id: item, label: item })),
    []
  );

  const parseCsv = (value: string) =>
    value
      .split(",")
      .map((v) => v.trim())
      .filter(Boolean);

  const parseScopes = (value: string) =>
    value
      .split(/\s+/)
      .map((v) => v.trim())
      .filter(Boolean);

  const sortStrings = (values: string[]) => [...new Set(values)].sort((a, b) => a.localeCompare(b));
  const sortNumbers = (values: string[]) =>
    [...new Set(values)]
      .map((v) => v.trim())
      .filter(Boolean)
      .sort((a, b) => Number(a) - Number(b));

  const cafe24ScopeValues = useMemo(
    () => sortStrings(parseScopes(cafe24Draft.scope)),
    [cafe24Draft.scope]
  );
  const cafe24BoardNoValues = useMemo(
    () => sortNumbers(parseCsv(cafe24Draft.board_no)),
    [cafe24Draft.board_no]
  );

  const shopifyScopeValues = useMemo(() => parseScopes(shopifyDraft.scopes), [shopifyDraft.scopes]);

  const revealFor = (field: string) => {
    setRevealedField(field);
    window.setTimeout(() => {
      setRevealedField((current) => (current === field ? null : current));
    }, 5000);
  };

  const shopDomainByNo = useMemo(() => {
    const map = new Map<string, string>();
    for (const opt of shopOptions) {
      if (opt.description) {
        map.set(opt.id, opt.description);
      }
    }
    return map;
  }, [shopOptions]);

  const buildMallDomainFromShopNo = (values: string[]) =>
    values
      .map((shopNo) => shopDomainByNo.get(shopNo))
      .filter(Boolean)
      .join(", ");

  const openDomain = (domain?: string) => {
    if (!domain) return;
    const url = domain.startsWith("http") ? domain : `https://${domain}`;
    window.open(url, "_blank", "noopener,noreferrer");
  };


  const loadShops = useCallback(async () => {
    if (!adminReady || !isAdmin || tab !== "env") return;
    if (activeProvider !== "cafe24") return;
    if (!cafe24Draft.mall_id || !cafe24Draft.access_token || !authToken) return;
    setShopLoading(true);
    setShopError(null);
    try {
      const res = await fetch("/api/cafe24/shops", {
        headers: {
          Authorization: `Bearer ${authToken}`,
        },
      });
      const payload = (await res.json()) as {
        shops?: Array<{
          shop_no: number;
          shop_name: string;
          primary_domain?: string | null;
          base_domain?: string | null;
        }>;
        error?: string;
      };
      if (!res.ok || payload.error) {
        setShopError(payload.error || "shop_no 목록을 불러오지 못했습니다.");
        setShopOptions([]);
        setShopLoading(false);
        return;
      }
      const options =
        payload.shops?.map((shop) => ({
          id: String(shop.shop_no),
          label: String(shop.shop_no),
          description: shop.primary_domain || shop.base_domain || shop.shop_name || "",
        })) || [];
      setShopOptions(options);
    } catch {
      setShopError("shop_no 목록을 불러오지 못했습니다.");
      setShopOptions([]);
    } finally {
      setShopLoading(false);
    }
  }, [
    adminReady,
    isAdmin,
    tab,
    authToken,
    activeProvider,
    cafe24Draft.mall_id,
    cafe24Draft.access_token,
  ]);

  useEffect(() => {
    if (!shopReloadKey) return;
    loadShops();
  }, [loadShops, shopReloadKey]);

  const refreshCafe24ForMall = useCallback(async () => {
    if (!authToken) return;
    setRefreshLoading(true);
    try {
      await fetch("/api/cafe24/refresh", {
        headers: {
          "x-cron-secret": "",
          Authorization: `Bearer ${authToken}`,
        },
      });
    } catch {
      // ignore refresh errors here
    } finally {
      setRefreshLoading(false);
    }
  }, [authToken]);

  const handleShopSearch = async () => {
    setShopOptions([]);
    setShopError(null);
    await refreshCafe24ForMall();
    setShopReloadKey((prev) => prev + 1);
  };

  useEffect(() => {
    if (activeProvider !== "cafe24") return;
    const values = sortNumbers(parseCsv(cafe24Draft.shop_no));
    if (values.length === 0) return;
    const nextDomain = buildMallDomainFromShopNo(values);
    if (nextDomain && nextDomain !== cafe24Draft.mall_domain) {
      setCafe24Draft((prev) => ({ ...prev, mall_domain: nextDomain }));
    }
  }, [activeProvider, cafe24Draft.shop_no, shopDomainByNo]);

  const buildCompanyInfoUrl = (fragment: string) =>
    `https://${cafe24Draft.mall_id || "{mall_id}"}.cafe24.com/admin/php/shop1/m/company_info_f.php#:~:text=${fragment}`;

  useEffect(() => {
    if (!adminReady || !isAdmin || tab !== "env" || !authToken) return;
    let active = true;
    const load = async () => {
      setEnvLoading(true);
      setEnvError(null);
      try {
        const res = await fetch(`/api/auth-settings/providers?provider=${activeProvider}`, {
          headers: {
            Authorization: `Bearer ${authToken}`,
          },
        });
        const payload = (await res.json()) as { provider?: Record<string, unknown>; error?: string };
        if (!active) return;
        if (!res.ok || payload.error) {
          setEnvError(payload.error || "환경 변수 정보를 불러오지 못했습니다.");
        } else if (payload.provider) {
          if (activeProvider === "cafe24") {
            setCafe24Draft((prev) => ({ ...prev, ...(payload.provider as Partial<Cafe24ProviderDraft>) }));
          } else {
            setShopifyDraft((prev) => ({ ...prev, ...(payload.provider as Partial<ShopifyProviderDraft>) }));
          }
        }
      } catch {
        if (active) setEnvError("환경 변수 정보를 불러오지 못했습니다.");
      } finally {
        if (active) setEnvLoading(false);
      }
    };
    load();
    return () => {
      active = false;
    };
  }, [adminReady, isAdmin, tab, authToken, activeProvider]);

  const handleProviderSave = async () => {
    setEnvLoading(true);
    setEnvError(null);
    try {
      const values = activeProvider === "cafe24" ? cafe24Draft : shopifyDraft;
      const res = await fetch("/api/auth-settings/providers", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${authToken}`,
        },
        body: JSON.stringify({ provider: activeProvider, values }),
      });
      const payload = (await res.json()) as { error?: string };
      if (!res.ok || payload.error) {
        setEnvError(payload.error || "저장에 실패했습니다.");
        return;
      }
      setEnvSavedAt(new Date().toISOString());
    } catch {
      setEnvError("저장에 실패했습니다.");
    } finally {
      setEnvLoading(false);
    }
  };

  return (
    <div className="px-5 md:px-8 pt-6 pb-[100px]">
      <div className="mx-auto w-full max-w-6xl">
        <div className="border-b border-slate-200 pb-2">
          <nav className="flex gap-2 overflow-x-auto">
            {tabs.map((t) => (
              <button
                key={t.key}
                onClick={() => router.push(`/app/settings?tab=${t.key}`)}
                className={cn(
                  "whitespace-nowrap rounded-xl border px-3 py-2 text-sm",
                  tab === t.key
                    ? "border-slate-300 bg-slate-100 text-slate-900"
                    : "border-transparent bg-transparent text-slate-600 hover:bg-slate-50"
                )}
              >
                {t.label}
              </button>
            ))}
          </nav>
        </div>

        <div className="mt-6">
          {tab === "workspaces" ? (
            <Card>
              <div className="divide-y divide-slate-200">
                <div className="flex items-center justify-between gap-3 px-4 py-2.5">
                  <div>
                    <div className="text-sm font-semibold text-slate-900">워크스페이스</div>
                    <div className="mt-1 text-sm text-slate-600">성지용 워크스페이스</div>
                    <div className="mt-1 text-xs text-slate-500">경로: /workspaces/01</div>
                  </div>
                  <button className="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50">
                    관리
                  </button>
                </div>
              </div>
            </Card>
          ) : tab === "team" ? (
            <Card>
              <div className="p-4">
                <div className="text-sm font-semibold text-slate-900">팀/권한</div>
                <div className="mt-2 grid grid-cols-1 gap-3 text-xs md:grid-cols-3">
                  {teamSeed.map((r) => (
                    <div key={r.role} className="rounded-xl border border-slate-200 bg-white p-3">
                      <div className="font-semibold text-slate-900">{r.role}</div>
                      <div className="mt-1 text-slate-600">{r.perms}</div>
                    </div>
                  ))}
                </div>
              </div>
            </Card>
          ) : tab === "audit" ? (
            <div className="space-y-3">
              {auditSeed.map((e, idx) => (
                <Card key={idx} className="p-4">
                  <div className="flex items-center justify-between">
                    <div className="text-slate-900">{e.what}</div>
                    <div className="text-slate-500">{e.t}</div>
                  </div>
                  <div className="mt-1 text-slate-600">{e.who}</div>
                </Card>
              ))}
            </div>
          ) : tab === "env" && isAdmin ? (
            <div className="space-y-4">
              <Card className="p-4">
                <div className="text-sm font-semibold text-slate-900">환경 변수 관리 안내</div>
                <div className="mt-2 text-sm text-slate-600">
                  영구 변수는 배포 환경(Railway 등)의 서버 환경 변수로 관리됩니다. 가변 변수는
                  사용자별/조직별 설정값으로 DB(auth_settings.providers)에 저장됩니다.
                </div>
              </Card>

              <Card className="p-4">
                <div className="text-sm font-semibold text-slate-900">서버 환경 변수</div>
                <div className="mt-3 grid gap-3 text-sm text-slate-700">
                  <div className="rounded-xl border border-slate-200 bg-white p-3">
                    <div className="font-semibold">NEXT_PUBLIC_SUPABASE_URL</div>
                    <div className="text-xs text-slate-500">Supabase 프로젝트 URL (필수)</div>
                  </div>
                  <div className="rounded-xl border border-slate-200 bg-white p-3">
                    <div className="font-semibold">NEXT_PUBLIC_SUPABASE_ANON_KEY</div>
                    <div className="text-xs text-slate-500">Supabase 공개 키 (필수)</div>
                  </div>
                  <div className="rounded-xl border border-slate-200 bg-white p-3">
                    <div className="font-semibold">SUPABASE_SERVICE_ROLE_KEY</div>
                    <div className="text-xs text-slate-500">서버 전용 키 (필수, Cron 갱신용)</div>
                  </div>
                  <div className="rounded-xl border border-slate-200 bg-white p-3">
                    <div className="font-semibold">CRON_SECRET</div>
                    <div className="text-xs text-slate-500">/api/cafe24/refresh 보호용 시크릿</div>
                  </div>
                  <div className="rounded-xl border border-slate-200 bg-white p-3">
                    <div className="font-semibold">CAFE24_REDIRECT_URI</div>
                    <div className="text-xs text-slate-500">Cafe24 OAuth 콜백 URL</div>
                  </div>
                  <div className="rounded-xl border border-slate-200 bg-white p-3">
                    <div className="font-semibold">CAFE24_CLIENT_ID</div>
                    <div className="text-xs text-slate-500">Cafe24 앱 Client ID (공통, 노출 금지)</div>
                  </div>
                  <div className="rounded-xl border border-slate-200 bg-white p-3">
                    <div className="font-semibold">CAFE24_CLIENT_SECRET</div>
                    <div className="text-xs text-slate-500">Cafe24 앱 Client Secret (공통, 노출 금지)</div>
                  </div>
                </div>
              </Card>

              <Card className="p-4">
                <div className="flex items-center justify-between gap-3">
                  <div>
                    <div className="text-sm font-semibold text-slate-900">환경 변수</div>
                    <div className="mt-1 text-xs text-slate-500">
                      아래 값은 auth_settings.providers.cafe24에 저장됩니다. OAuth 완료 시
                      access/refresh_token, expires_at은 자동으로 업데이트됩니다.
                    </div>
                  </div>
                  <div className="flex items-center gap-2 min-w-0">
                    <div className="w-32 min-w-0">
                      <SelectPopover
                        value={activeProvider}
                        onChange={(next) => setActiveProvider(next as ProviderKey)}
                        options={providerOptions}
                        className="min-w-0"
                        buttonClassName="w-full min-w-0"
                      />
                    </div>
                    <button
                      onClick={handleProviderSave}
                      className="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50 whitespace-nowrap shrink-0 max-w-[80px] truncate"
                      disabled={envLoading}
                    >
                      저장
                    </button>
                  </div>
                </div>

                {envError ? <div className="mt-3 text-sm text-rose-600">{envError}</div> : null}
                {envSavedAt ? (
                  <div className="mt-2 text-xs text-slate-500">저장됨: {envSavedAt}</div>
                ) : null}

                {activeProvider === "cafe24" ? (
                  <div className="mt-4 grid gap-3 md:grid-cols-2 min-w-0">
                    <label className="relative grid gap-1 text-xs font-medium text-slate-600 min-w-0">
                      <span className="inline-flex items-center gap-1">
                        mall_id
                        <a
                          href={buildCompanyInfoUrl("상점%20아이디")}
                          type="button"
                          className="text-slate-400 hover:text-slate-600"
                          target="_blank"
                          rel="noreferrer"
                          title="mall_id 위치 열기"
                        >
                          <ExternalLink className="h-3.5 w-3.5" />
                        </a>
                      </span>
                      <input
                        className="h-9 w-full rounded-lg border border-slate-200 px-3 pr-9 text-sm truncate"
                        value={cafe24Draft.mall_id}
                        onChange={(event) =>
                          setCafe24Draft((prev) => ({ ...prev, mall_id: event.target.value }))
                        }
                        disabled={envReadOnly && !editableCafe24Keys.has("mall_id")}
                      />
                      <button
                        type="button"
                        onClick={handleShopSearch}
                        className="absolute right-2 top-[38px] -translate-y-1/2 rounded-full border border-slate-200 bg-white p-1 text-slate-500 hover:bg-slate-50"
                        title="shop_no 탐색"
                      >
                        <Search className="h-3.5 w-3.5" />
                      </button>
                      {refreshLoading ? (
                        <div className="mt-1 text-[10px] text-slate-500">mall_id 확인 중...</div>
                      ) : (
                        <div className="mt-1 text-[10px] text-slate-500">
                          탐색 버튼을 클릭하면 shop_no 도메인을 찾습니다.
                        </div>
                      )}
                    </label>
                    <label className="grid gap-1 text-xs font-medium text-slate-600 min-w-0">
                      <span className="inline-flex items-center gap-1">
                        mall_domain (optional)
                        <a
                          href={buildCompanyInfoUrl("기본제공%20도메인")}
                          type="button"
                          className="text-slate-400 hover:text-slate-600"
                          target="_blank"
                          rel="noreferrer"
                          title="mall_domain 위치 열기"
                        >
                          <ExternalLink className="h-3.5 w-3.5" />
                        </a>
                      </span>
                      <input
                        className="h-9 rounded-lg border border-slate-200 px-3 text-sm truncate"
                        value={cafe24Draft.mall_domain}
                        onChange={(event) =>
                          setCafe24Draft((prev) => ({ ...prev, mall_domain: event.target.value }))
                        }
                        disabled={
                          (envReadOnly && !editableCafe24Keys.has("mall_domain")) ||
                          Boolean(cafe24Draft.shop_no)
                        }
                      />
                    </label>
                    <label className="grid gap-1 text-xs font-medium text-slate-600 min-w-0">
                      <span className="inline-flex items-center gap-1">access_token</span>
                      <div className="relative">
                        <input
                          type={revealedField === "cafe24.access_token" ? "text" : "password"}
                          className="h-9 w-full rounded-lg border border-slate-200 px-3 pr-9 text-sm truncate"
                          value={cafe24Draft.access_token}
                          onChange={(event) =>
                            setCafe24Draft((prev) => ({ ...prev, access_token: event.target.value }))
                          }
                          disabled
                        />
                        <button
                          type="button"
                          onClick={() => revealFor("cafe24.access_token")}
                          className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                          aria-label="access_token 표시"
                        >
                          {revealedField === "cafe24.access_token" ? (
                            <EyeOff className="h-4 w-4 opacity-70" />
                          ) : (
                            <Eye className="h-4 w-4 opacity-70" />
                          )}
                        </button>
                      </div>
                    </label>
                    <label className="grid gap-1 text-xs font-medium text-slate-600 min-w-0">
                      <span className="inline-flex items-center gap-1">refresh_token</span>
                      <div className="relative">
                        <input
                          type={revealedField === "cafe24.refresh_token" ? "text" : "password"}
                          className="h-9 w-full rounded-lg border border-slate-200 px-3 pr-9 text-sm truncate"
                          value={cafe24Draft.refresh_token}
                          onChange={(event) =>
                            setCafe24Draft((prev) => ({ ...prev, refresh_token: event.target.value }))
                          }
                          disabled
                        />
                        <button
                          type="button"
                          onClick={() => revealFor("cafe24.refresh_token")}
                          className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                          aria-label="refresh_token 표시"
                        >
                          {revealedField === "cafe24.refresh_token" ? (
                            <EyeOff className="h-4 w-4 opacity-70" />
                          ) : (
                            <Eye className="h-4 w-4 opacity-70" />
                          )}
                        </button>
                      </div>
                    </label>
                    <label className="grid gap-1 text-xs font-medium text-slate-600 min-w-0 relative">
                      <span className="inline-flex items-center gap-1">scope(권한 범위, multi)</span>
                      <MultiSelectPopover
                        values={cafe24ScopeValues}
                        onChange={(values) =>
                          setCafe24Draft((prev) => ({ ...prev, scope: sortStrings(values).join(" ") }))
                        }
                        options={cafe24ScopeOptions}
                        displayMode="count"
                        showBulkActions
                        className="w-full"
                        buttonClassName="w-full min-w-0"
                      />
                    </label>
                    <label className="grid gap-1 text-xs font-medium text-slate-600 min-w-0">
                      <span className="inline-flex items-center gap-1">shop_no(멀티쇼핑몰 번호, multi)</span>
                      <MultiSelectPopover
                        values={sortNumbers(parseCsv(cafe24Draft.shop_no))}
                        onChange={(values) => {
                          const ordered = sortNumbers(values);
                          const domain = buildMallDomainFromShopNo(ordered);
                          setCafe24Draft((prev) => ({
                            ...prev,
                            shop_no: ordered.join(","),
                            mall_domain: domain || prev.mall_domain,
                          }));
                        }}
                        options={shopOptions}
                        searchable={false}
                        disabled={envReadOnly && !editableCafe24Keys.has("shop_no")}
                        showBulkActions
                        className="w-full"
                        buttonClassName="w-full min-w-0"
                        renderValue={(selected) =>
                          selected.length === 0 ? (
                            "선택"
                          ) : (
                            <span className="truncate block w-full">
                              {sortNumbers(selected.map((opt) => opt.id)).join(", ")}
                            </span>
                          )
                        }
                        renderOption={(option) => (
                          <div className="min-w-0 text-left">
                            <div className="flex items-center gap-2 truncate">
                              <span className="text-slate-900">{option.label}</span>
                              {option.description ? (
                                <span
                                  role="link"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    openDomain(option.description);
                                  }}
                                  className="text-[10px] text-slate-500 underline cursor-pointer truncate"
                                >
                                  {option.description}
                                </span>
                              ) : null}
                            </div>
                          </div>
                        )}
                      />
                      {shopLoading ? (
                        <span className="text-[10px] text-slate-500">shop_no 불러오는 중...</span>
                      ) : shopError ? (
                        <span className="text-[10px] text-rose-600">{shopError}</span>
                      ) : null}
                    </label>
                    <label className="grid gap-1 text-xs font-medium text-slate-600 min-w-0">
                      <span className="inline-flex items-center gap-1">board_no(게시판 번호, multi)</span>
                      <MultiSelectPopover
                        values={sortNumbers(cafe24BoardNoValues)}
                        onChange={(values) =>
                          setCafe24Draft((prev) => ({ ...prev, board_no: sortNumbers(values).join(",") }))
                        }
                        options={boardNoOptions}
                        searchable={false}
                        disabled={envReadOnly && !editableCafe24Keys.has("board_no")}
                        showBulkActions
                        className="w-full"
                        buttonClassName="w-full min-w-0"
                        renderValue={(selected) =>
                          selected.length === 0 ? (
                            "선택"
                          ) : (
                            <span className="truncate block w-full">
                              {sortNumbers(selected.map((opt) => opt.id)).join(", ")}
                            </span>
                          )
                        }
                      />
                    </label>
                  </div>
                ) : (
                  <div className="mt-4 grid gap-3 md:grid-cols-2">
                    <label className="grid gap-1 text-xs font-medium text-slate-600 min-w-0">
                      shop_domain
                      <input
                        className="h-9 rounded-lg border border-slate-200 px-3 text-sm"
                        value={shopifyDraft.shop_domain}
                        onChange={(event) =>
                          setShopifyDraft((prev) => ({ ...prev, shop_domain: event.target.value }))
                        }
                        disabled={envReadOnly}
                      />
                    </label>
                    <label className="grid gap-1 text-xs font-medium text-slate-600 min-w-0">
                      client_id
                      <input
                        className="h-9 rounded-lg border border-slate-200 px-3 text-sm"
                        value={shopifyDraft.client_id}
                        onChange={(event) =>
                          setShopifyDraft((prev) => ({ ...prev, client_id: event.target.value }))
                        }
                        disabled={envReadOnly}
                      />
                    </label>
                    <label className="grid gap-1 text-xs font-medium text-slate-600 min-w-0">
                      client_secret
                      <div className="relative">
                        <input
                          type={revealedField === "shopify.client_secret" ? "text" : "password"}
                          className="h-9 w-full rounded-lg border border-slate-200 px-3 pr-9 text-sm"
                          value={shopifyDraft.client_secret}
                          onChange={(event) =>
                            setShopifyDraft((prev) => ({ ...prev, client_secret: event.target.value }))
                          }
                          disabled={envReadOnly}
                        />
                        <button
                          type="button"
                          onClick={() => revealFor("shopify.client_secret")}
                          className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                          aria-label="client_secret 표시"
                        >
                          {revealedField === "shopify.client_secret" ? (
                            <EyeOff className="h-4 w-4 opacity-70" />
                          ) : (
                            <Eye className="h-4 w-4 opacity-70" />
                          )}
                        </button>
                      </div>
                    </label>
                    <label className="grid gap-1 text-xs font-medium text-slate-600 min-w-0">
                      access_token
                      <div className="relative">
                        <input
                          type={revealedField === "shopify.access_token" ? "text" : "password"}
                          className="h-9 w-full rounded-lg border border-slate-200 px-3 pr-9 text-sm"
                          value={shopifyDraft.access_token}
                          onChange={(event) =>
                            setShopifyDraft((prev) => ({ ...prev, access_token: event.target.value }))
                          }
                          disabled={envReadOnly}
                        />
                        <button
                          type="button"
                          onClick={() => revealFor("shopify.access_token")}
                          className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                          aria-label="access_token 표시"
                        >
                          {revealedField === "shopify.access_token" ? (
                            <EyeOff className="h-4 w-4 opacity-70" />
                          ) : (
                            <Eye className="h-4 w-4 opacity-70" />
                          )}
                        </button>
                      </div>
                    </label>
                    <label className="grid gap-1 text-xs font-medium text-slate-600 min-w-0">
                      scopes (multi)
                      <MultiSelectPopover
                        values={shopifyScopeValues}
                        onChange={(values) =>
                          setShopifyDraft((prev) => ({ ...prev, scopes: values.join(" ") }))
                        }
                        options={shopifyScopeOptions}
                        disabled={envReadOnly}
                      />
                    </label>
                  </div>
                )}
              </Card>
            </div>
          ) : (
            <Card>
              <div className="divide-y divide-slate-200">
                <div className="flex items-center justify-between gap-3 px-4 py-2.5">
                  <div className="flex flex-col">
                    <p className="text-sm font-semibold text-slate-900">이메일 주소</p>
                    <p className="text-sm text-slate-600">{email}</p>
                  </div>
                </div>

                <div className="flex items-center justify-between gap-3 px-4 py-2.5">
                  <div className="flex flex-col">
                    <p className="text-sm font-semibold text-slate-900">이름</p>
                    <p className="text-sm text-slate-600">{givenName}</p>
                  </div>
                  <button className="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50">
                    이름 변경
                  </button>
                </div>

                <div className="flex items-center justify-between gap-3 px-4 py-2.5">
                  <div className="flex flex-col">
                    <p className="text-sm font-semibold text-slate-900">현재 플랜</p>
                    <p className="text-sm text-slate-600">무료</p>
                  </div>
                  <Link
                    href="/app/billing"
                    className="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50"
                  >
                    구독 관리
                  </Link>
                </div>

                <div className="flex items-center justify-between gap-3 px-4 py-2.5">
                  <div className="flex flex-col">
                    <p className="text-sm font-semibold text-slate-900">도움 패널</p>
                    <p className="text-sm text-slate-600">
                      서비스 사용 순서와 후속 지원 요청 대상 바로가기를 표시합니다.
                    </p>
                  </div>
                  <button
                    onClick={() => setHelpPanelEnabled((v) => !v)}
                    className={cn(
                      "rounded-xl border px-3 py-2 text-sm",
                      helpPanelEnabled
                        ? "border-emerald-200 bg-emerald-50 text-emerald-700"
                        : "border-slate-200 bg-white text-slate-700"
                    )}
                  >
                    {helpPanelEnabled ? "ON" : "OFF"}
                  </button>
                </div>

                <div className="flex items-center justify-between gap-3 px-4 py-2.5">
                  <div className="flex flex-col">
                    <p className="text-sm font-semibold text-slate-900">모든 기기에서 로그아웃</p>
                    <p className="text-sm text-slate-600">모든 기기 및 세션에서 로그아웃합니다.</p>
                  </div>
                  <button className="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50">
                    로그아웃
                  </button>
                </div>

                <div className="flex items-center justify-between gap-3 px-4 py-2.5">
                  <div className="flex flex-col">
                    <p className="text-sm font-semibold text-rose-600">계정 삭제</p>
                    <p className="text-sm text-slate-600">계정 삭제는 되돌릴 수 없습니다.</p>
                  </div>
                  <button className="rounded-xl border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-600 hover:bg-rose-100">
                    계정 삭제
                  </button>
                </div>
              </div>
            </Card>
          )}
        </div>
      </div>
    </div>
  );
}

139:      base.push({ key: "env", label: "환경 변수" });
401:          setEnvError(payload.error || "환경 변수 정보를 불러오지 못했습니다.");
410:        if (active) setEnvError("환경 변수 정보를 불러오지 못했습니다.");
514:                <div className="text-sm font-semibold text-slate-900">환경 변수 관리 안내</div>
516:                  영구 변수는 배포 환경(Railway 등)의 서버 환경 변수로 관리됩니다. 가변 변수는
522:                <div className="text-sm font-semibold text-slate-900">서버 환경 변수</div>
558:                    <div className="text-sm font-semibold text-slate-900">환경 변수</div>

                    <div className="font-semibold">CAFE24_REDIRECT_URI</div>
                    <div className="text-xs text-slate-500">Cafe24 OAuth 콜백 URL</div>
                  </div>
                  <div className="rounded-xl border border-slate-200 bg-white p-3">
                    <div className="font-semibold">CAFE24_CLIENT_ID</div>
                    <div className="text-xs text-slate-500">Cafe24 앱 Client ID (공통, 노출 금지)</div>
                  </div>
                  <div className="rounded-xl border border-slate-200 bg-white p-3">
                    <div className="font-semibold">CAFE24_CLIENT_SECRET</div>
                    <div className="text-xs text-slate-500">Cafe24 앱 Client Secret (공통, 노출 금지)</div>
                  </div>
                </div>
              </Card>

              <Card className="p-4">
                <div className="flex items-center justify-between gap-3">
                  <div>
                    <div className="text-sm font-semibold text-slate-900">환경 변수</div>
                    <div className="mt-1 text-xs text-slate-500">
                      아래 값은 auth_settings.providers.cafe24에 저장됩니다. OAuth 완료 시
                      access/refresh_token, expires_at은 자동으로 업데이트됩니다.
                    </div>
                  </div>
                  <div className="flex items-center gap-2 min-w-0">
                    <div className="w-32 min-w-0">
                      <SelectPopover
                        value={activeProvider}
                        onChange={(next) => setActiveProvider(next as ProviderKey)}
                        options={providerOptions}
                        className="min-w-0"
                        buttonClassName="w-full min-w-0"
                      />
                    </div>
                    <button
                      onClick={handleProviderSave}
                      className="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50 whitespace-nowrap shrink-0 max-w-[80px] truncate"
                      disabled={envLoading}
                    >
                      저장
                    </button>
                  </div>
                </div>

                {envError ? <div className="mt-3 text-sm text-rose-600">{envError}</div> : null}
                {envSavedAt ? (
                  <div className="mt-2 text-xs text-slate-500">저장됨: {envSavedAt}</div>
                ) : null}

                {activeProvider === "cafe24" ? (
                  <div className="mt-4 grid gap-3 md:grid-cols-2 min-w-0">
                    <label className="relative grid gap-1 text-xs font-medium text-slate-600 min-w-0">
                      <span className="inline-flex items-center gap-1">
                        mall_id
                        <a
                          href={buildCompanyInfoUrl("상점%20아이디")}
                          type="button"
                          className="text-slate-400 hover:text-slate-600"
                          target="_blank"
                          rel="noreferrer"
                          title="mall_id 위치 열기"
                        >
                          <ExternalLink className="h-3.5 w-3.5" />
                        </a>
                      </span>
                      <input
                        className="h-9 w-full rounded-lg border border-slate-200 px-3 pr-9 text-sm truncate"
                        value={cafe24Draft.mall_id}
                        onChange={(event) =>
                          setCafe24Draft((prev) => ({ ...prev, mall_id: event.target.value }))
                        }
                        disabled={envReadOnly && !editableCafe24Keys.has("mall_id")}
                      />
                      <button
                        type="button"
                        onClick={handleShopSearch}
                        className="absolute right-2 top-[38px] -translate-y-1/2 rounded-full border border-slate-200 bg-white p-1 text-slate-500 hover:bg-slate-50"
                        title="shop_no 탐색"
                      >
                        <Search className="h-3.5 w-3.5" />
                      </button>
                      {refreshLoading ? (
                        <div className="mt-1 text-[10px] text-slate-500">mall_id 확인 중...</div>
                      ) : (
                        <div className="mt-1 text-[10px] text-slate-500">
                          탐색 버튼을 클릭하면 shop_no 도메인을 찾습니다.
                        </div>
                      )}
                    </label>
                    <label className="grid gap-1 text-xs font-medium text-slate-600 min-w-0">
                      <span className="inline-flex items-center gap-1">
                        mall_domain (optional)
                        <a
                          href={buildCompanyInfoUrl("기본제공%20도메인")}
                          type="button"
                          className="text-slate-400 hover:text-slate-600"
                          target="_blank"
                          rel="noreferrer"
                          title="mall_domain 위치 열기"
                        >
                          <ExternalLink className="h-3.5 w-3.5" />
                        </a>
                      </span>
                      <input
                        className="h-9 rounded-lg border border-slate-200 px-3 text-sm truncate"
                        value={cafe24Draft.mall_domain}
                        onChange={(event) =>
                          setCafe24Draft((prev) => ({ ...prev, mall_domain: event.target.value }))
                        }
                        disabled={
                          (envReadOnly && !editableCafe24Keys.has("mall_domain")) ||
                          Boolean(cafe24Draft.shop_no)
                        }
                      />
                    </label>
                    <label className="grid gap-1 text-xs font-medium text-slate-600 min-w-0">
                      <span className="inline-flex items-center gap-1">access_token</span>
                      <div className="relative">
                        <input
                          type={revealedField === "cafe24.access_token" ? "text" : "password"}
                          className="h-9 w-full rounded-lg border border-slate-200 px-3 pr-9 text-sm truncate"
                          value={cafe24Draft.access_token}
                          onChange={(event) =>
                            setCafe24Draft((prev) => ({ ...prev, access_token: event.target.value }))
                          }
                          disabled
                        />
                        <button
                          type="button"
                          onClick={() => revealFor("cafe24.access_token")}
                          className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                          aria-label="access_token 표시"
                        >
                          {revealedField === "cafe24.access_token" ? (
                            <EyeOff className="h-4 w-4 opacity-70" />
                          ) : (
                            <Eye className="h-4 w-4 opacity-70" />
                          )}
                        </button>
                      </div>
                    </label>
                    <label className="grid gap-1 text-xs font-medium text-slate-600 min-w-0">
                      <span className="inline-flex items-center gap-1">refresh_token</span>
                      <div className="relative">
                        <input
                          type={revealedField === "cafe24.refresh_token" ? "text" : "password"}
                          className="h-9 w-full rounded-lg border border-slate-200 px-3 pr-9 text-sm truncate"
                          value={cafe24Draft.refresh_token}
                          onChange={(event) =>
                            setCafe24Draft((prev) => ({ ...prev, refresh_token: event.target.value }))
                          }
                          disabled
                        />
                        <button
                          type="button"
                          onClick={() => revealFor("cafe24.refresh_token")}
                          className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                          aria-label="refresh_token 표시"
                        >
                          {revealedField === "cafe24.refresh_token" ? (
                            <EyeOff className="h-4 w-4 opacity-70" />

2026-01-27_18-47-46
