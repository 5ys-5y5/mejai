#질문
MK2 route
/api/runtime/chat/shipping
세션 1927e35d-daf8-4a1d-ad01-c8da5ea12649
보기
배송지 변경
주문 정보를 변경하려면 주문번호가 필요합니다. 주문번호 또는 휴대폰 번호를 알려주세요.
01093107159
조회된 주문이 여러 건입니다. 원하는 주문번호를 알려주세요. - 20260127-0000014 2026-01-27T01:49:00+09:00 - 20260126-0000012 2026-01-26T18:44:57+09:00
20260127-0000014
배송지 변경을 위해 새 주소를 알려주세요. 예) 주소: 서울시 ... (가능하면 우편번호 포함)
(08813) 서울 관악구 신림동 1515-7 503
요약: 주문 정보(배송지 주소) 변경을 요청하셨으나, 주문번호 정보가 필요합니다. 근거: - KB "주문 정보 변경 안내"에 따르면, 주문 정보 변경을 위해서는 주문번호가 반드시 필요합니다. - [ADMIN KB] 및 MCP 정책에 따라 주문번호 또는 휴대폰 번호가 없는 경우 주문 변경 처리가 불가합니다. 상세: - 배송지 주소, 수령인 정보 등 주문 정보 변경은 "결제 완료 ~ 배송 준비 중" 상태에서만 가능합니다. - 변경을 원하시는 경우 주문번호 또는 주문에 사용한 휴대폰 번호를 알려주셔야 처리가 가능합니다. 다음 액션: - 주문번호 또는 주문에 사용한 휴대폰 번호를 입력해 주세요. 확인 후 변경 요청을 도와드리겠습니다.

#답변
두 번째 문제(주소 입력 후 주문번호 재요구)가 계속 발생한 이유는 **직전 1턴만 참고**해서 상태를 복원했기 때문입니다.  
주문번호를 입력한 턴이 한 단계 앞에서 누락되면, 다음 턴에서는 다시 “주문번호 필요”로 회귀합니다.

그래서 **최근 여러 턴을 스캔해서 order_id/phone/address를 복원**하도록 강화했습니다.

수정 내용
- 최근 5개 턴을 조회해 bot_context + transcript에서 order_id/phone/address/zipcode를 복원
- `selected_order_id`가 있으면 최우선 적용
- order_id가 한번 결정되면 이후 턴에서도 유지

수정 파일
- `src/app/api/runtime/chat/legacy/route_mk2.ts`

이제 다음 흐름에서 order_id가 유지되어 update_order_shipping_address까지 이어져야 합니다.
1) “배송지 변경”
2) “01093107159”
3) “1번” 또는 주문번호 직접 입력
4) 주소 입력  
→ order_id가 유지되어 즉시 변경 실행
