#질문
1. http://localhost:3000/app/kb/new 페이지의 ADMIN 공통 KB 모드에서 Policy JSON 양식에 맞게 값을 입력할 수 있도록 구현할 것.
추가시 하드코딩이 불가피한 영역에 대한 설명도 같이 기록할 것

2. C:\dev\1227\mejai\src\app\api\playground\chat\route.ts와  C:\dev\1227\mejai\src\lib\llm.ts를 참고하여 Policy JSON 초안을 제공할 것.
(http://localhost:3000/app/kb/new 페이지에 그대로 붙여 넣을 수 있는 텍스트를 제공할 것)
(권장되는 방식은 이미 추가 가능한 항목에 대해 +버튼을 누르면 활성화하고 인풋을 받을 수 있는 방식을 사용할 것. 더 우수한 방식이 있다면 해당 방식으로 구현할 것)

3. http://localhost:3000/app/kb/new 페이지의 ADMIN 공통 KB 모드 선택시 admin KB의 활용 흐름을 직관적으로 이해할 수 있도록 데이터 흐름으로 명시할 것

# 답변
요청하신 UI/로직을 반영했습니다. ADMIN 공통 KB에서 policy_pack을 선택하면 Policy JSON을 직접 입력/추가 버튼으로 생성할 수 있고, 데이터 흐름 안내도 화면에 표시됩니다.

적용 내용
- ADMIN KB 종류 선택 추가 (policy_pack/template_pack/gate_config)
- policy_pack 선택 시 Policy JSON 입력 영역 + +버튼(규칙/템플릿/툴정책 추가)
- Policy JSON 검증 실패 시 저장 차단
- content는 Policy JSON과 자동 동기화 (policy_pack일 때는 내용 입력 비활성)
- ADMIN KB 데이터 흐름 안내 카드 표시
- 하드코딩 불가피 영역 안내(Policy JSON 영역 하단)

변경 파일
- `src/app/app/kb/new/page.tsx`
- `src/app/api/kb/route.ts`

하드코딩이 불가피한 영역(설명)
- 새 predicate 추가 시: `src/lib/policyEngine.ts`의 matchPredicate()에 로직 추가 필요
  예: text.contains_abuse, intent.is, entity.order_id.present 등
- 새 action 타입 추가 시: `src/lib/policyEngine.ts`의 applyActions()에 실행 로직 추가 필요
  예: force_response_template, deny_tools, force_tool_call 등
- 이는 “행동 보장”을 위한 Gate 실행이므로, JSON만으로는 수행 불가합니다.

Policy JSON 초안 (붙여넣기용)
아래 JSON을 `/app/kb/new`의 policy_pack 입력창에 그대로 붙여넣으면 됩니다.

{
  "rules": [
    {
      "id": "R001_abuse",
      "stage": "input",
      "priority": 1000,
      "when": {
        "any": [
          { "predicate": "text.contains_abuse" }
        ]
      },
      "enforce": {
        "actions": [
          { "type": "set_flag", "flag": "conversation.abusive", "value": true },
          { "type": "force_response_template", "template_id": "abuse_warn" },
          { "type": "deny_tools", "tools": ["*"] }
        ]
      }
    },
    {
      "id": "R005_repeat_cooldown",
      "stage": "input",
      "priority": 900,
      "when": {
        "any": [
          { "predicate": "conversation.repeat_over", "args": { "count": 2 } }
        ]
      },
      "enforce": {
        "actions": [
          { "type": "force_response_template", "template_id": "repeat_block" }
        ]
      }
    },
    {
      "id": "R010_need_order_id_for_lookup",
      "stage": "tool",
      "priority": 950,
      "when": {
        "all": [
          { "predicate": "intent.is_one_of", "args": { "values": ["shipment", "order_lookup"] } },
          { "predicate": "entity.order_id.missing" }
        ]
      },
      "enforce": {
        "actions": [
          { "type": "deny_tools", "tools": ["lookup_order", "track_shipment"] },
          { "type": "force_response_template", "template_id": "need_order_id" }
        ]
      }
    },
    {
      "id": "R020_address_change_create_ticket",
      "stage": "tool",
      "priority": 920,
      "when": {
        "all": [
          { "predicate": "intent.is", "args": { "value": "change" } },
          { "predicate": "entity.order_id.present" },
          { "predicate": "entity.address.present" },
          { "predicate": "user.confirmed", "args": { "value": true } }
        ]
      },
      "enforce": {
        "actions": [
          {
            "type": "force_tool_call",
            "tool": "create_ticket",
            "args_template": {
              "title": "배송지 변경 요청 - {{entity.order_id}}",
              "content": "배송지 변경 요청: {{entity.address}}\n주문번호: {{entity.order_id}}\n요청: {{input.text}}"
            }
          }
        ]
      }
    },
    {
      "id": "R030_output_format",
      "stage": "output",
      "priority": 800,
      "when": {
        "any": [
          { "predicate": "text.contains_pii" }
        ]
      },
      "enforce": {
        "actions": [
          { "type": "format_output" }
        ]
      }
    }
  ],
  "templates": {
    "abuse_warn": "불편을 드려 죄송합니다. 원활한 안내를 위해 정중한 표현으로 말씀 부탁드립니다. 주문번호나 휴대폰 번호를 알려주시면 바로 확인해 드리겠습니다.",
    "repeat_block": "같은 문의가 반복되고 있습니다. 주문번호/휴대폰 번호 중 하나를 알려주시면 즉시 처리하겠습니다.",
    "need_order_id": "주문 조회를 위해 주문번호가 필요합니다. 주문번호를 알려주세요."
  },
  "tool_policies": {
    "lookup_order": {
      "required_args": ["order_id"],
      "arg_validators": { "order_id": { "regex": "^[0-9]{8}-[0-9]{7}$" } }
    },
    "track_shipment": {
      "required_args": ["order_id"]
    },
    "create_ticket": {
      "required_args": ["title", "content"]
    }
  }
}

ADMIN KB 데이터 흐름(UI 표기)
- 생성 → 정책 KB 로딩 → apply_groups 매칭 → 입력/툴/출력 Gate 적용 → 답변 생성

추가 요청 시
- predicate/action 타입 확장 항목을 알려주시면 policyEngine에 바로 추가하겠습니다.
