# 단계별 구현 체크리스트 및 검증

> 기준: UI 없이 서비스(LLM+KB 필수, MCP 선택) 백엔드 동작을 검증한다.
> 목표: MCP가 세션 인증 기반으로 동작하고, Cafe24 인증값은 DB(auth_settings)에서 로드/갱신되어 호출된다.

## 0) 배포 코드 버전 확인
- [ ] `src/lib/mcpAdapters.ts`에서 Cafe24 설정을 `auth_settings.providers.cafe24`에서 읽도록 구현되어 있다.
- [ ] `src/app/api/cafe24/authorize/route.ts`가 DB(auth_settings)에서 `mall_id`, `client_id`, `scope`를 읽는다.
- [ ] `src/app/api/cafe24/callback/route.ts`가 DB(auth_settings)에 토큰을 저장한다.
- [ ] `src/app/api/mcp/tools/call/route.ts`가 `callAdapter`에 `supabase/orgId/userId` 컨텍스트를 전달한다.
- [ ] `src/app/api/mcp/tools/route.ts`에 `MCP_TOKEN` 환경변수 fallback이 제거되어 있다.

## 1) DB 스키마 확인
- [ ] `auth_settings` 테이블 존재
- [ ] `auth_oauth_tokens` 테이블 제거됨(사용하지 않음)
- [ ] `auth_settings`의 RLS 정책(`auth_settings_read/write/update`) 존재

## 2) DB 데이터 확인 (auth_settings)
- [ ] `providers.cafe24`에 다음 키가 존재
  - [ ] `mall_id`
  - [ ] `client_id`
  - [ ] `client_secret`
  - [ ] `scope`
  - [ ] `access_token`
  - [ ] `refresh_token`
  - [ ] `expires_at`
  - [ ] `shop_no` (선택)
  - [ ] `board_no` (선택)
- [ ] `org_id` / `user_id`가 현재 로그인 유저와 일치

## 3) Cafe24 OAuth 연결 흐름 (서비스 기준)
- [ ] 사용자가 로그인한 상태에서 `https://mejai.help/api/cafe24/authorize` 접근 시 302로 Cafe24 승인 URL로 이동
- [ ] 승인 후 콜백(`https://mejai.help/api/cafe24/callback`)에서 DB에 토큰 저장
- [ ] 콜백 응답이 `status: stored` 화면을 반환

## 4) MCP 인증 동작
- [ ] 브라우저 로그인 세션 쿠키만으로 `/api/mcp/tools/call` 접근 가능
- [ ] `MCP_TOKEN` 환경변수가 없어도 서비스에서 정상 인증됨

## 5) MCP 도구 등록 여부
- [ ] `list_boards`, `list_board_articles`, `list_orders`, `find_customer_by_phone`가 `mcp_tools`에 존재
- [ ] 해당 도구들이 `mcp_tool_policies`에 org_id 기준으로 허용됨

## 6) MCP 기능 동작 검증 (서비스 기준)
- [ ] `list_boards` 정상 응답
- [ ] `list_board_articles` 정상 응답
- [ ] `list_orders` 정상 응답
- [ ] `find_customer_by_phone` 정상 응답
- [ ] `lookup_order`, `track_shipment`, `create_ticket` 정상 응답

## 7) 토큰 자동 갱신 검증
- [ ] `expires_at`가 과거여도 요청 시 refresh_token으로 갱신
- [ ] 갱신 후 `auth_settings.providers.cafe24.access_token`과 `expires_at`이 업데이트됨
- [ ] 갱신 실패 시 명확한 에러 코드(`TOKEN_REFRESH_FAILED`) 반환

---

## 확인 로그 (진행 중)
- [ ] 0) 배포 코드 버전 확인
- [ ] 1) DB 스키마 확인
- [ ] 2) DB 데이터 확인
- [ ] 3) OAuth 연결 흐름
- [ ] 4) MCP 인증 동작
- [ ] 5) MCP 도구 등록 여부
- [ ] 6) MCP 기능 동작 검증
- [ ] 7) 토큰 자동 갱신 검증
